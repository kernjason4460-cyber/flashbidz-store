<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlashBidz Store ‚Äî Local Deals ‚Ä¢ Mattawan, MI</title>

  <meta
    name="description"
    content="FlashBidz Store ‚Äî fixed-price local deals with easy pickup and simple flat-rate shipping. Neighbors helping neighbors."
  />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg: #f3f4f6;
      --bg-alt: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #dc2626;
      --primary-soft: rgba(220, 38, 38, 0.08);
      --accent: #f97316;
      --border: #e5e7eb;
      --card-radius: 18px;
      --shadow-soft: 0 14px 30px rgba(15, 23, 42, 0.16);
    }

    [data-theme="dark"] {
      --bg: #020617;
      --bg-alt: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary-soft: rgba(248, 113, 113, 0.16);
      --border: #1f2937;
      --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.65);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100%;
      -webkit-font-smoothing: antialiased;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    img {
      max-width: 100%;
      display: block;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
    }

    /* HEADER */

    .site-header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(18px);
      background: linear-gradient(
        to right,
        rgba(15, 23, 42, 0.97),
        rgba(30, 64, 175, 0.97)
      );
      color: #f9fafb;
      padding: 0.6rem 0.85rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
    }

    @media (min-width: 768px) {
      .site-header {
        padding-inline: 1.25rem;
      }
    }

    .site-header .brand {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      min-width: 0;
    }

    .logoimg {
      height: 34px;
      width: auto;
    }

    @media (min-width: 768px) {
      .logoimg {
        height: 40px;
      }
    }

    .site-header .name h1 {
      font-size: 1rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin: 0;
      white-space: nowrap;
    }

    @media (min-width: 768px) {
      .site-header .name h1 {
        font-size: 1.1rem;
      }
    }

    .site-header .name .tagline {
      margin: 0;
      font-size: 0.7rem;
      opacity: 0.9;
      white-space: nowrap;
    }

    .top-cta {
      display: flex;
      gap: 0.45rem;
      align-items: center;
      flex-wrap: nowrap;
    }

    @media (max-width: 480px) {
      .top-cta a:nth-of-type(2) {
        display: none;
      }
    }

    /* --- MOBILE HEADER LAYOUT FIX --- */
    @media (max-width: 640px) {
      .site-header {
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        flex-wrap: nowrap;
        padding-top: 0.6rem;
        padding-bottom: 0.6rem;
        gap: 0.5rem;
      }

      .site-header .brand {
        width: 100%;
        display: flex;
        align-items: center;
      }

      .top-cta {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 0.4rem;
      }

      .top-cta .btn,
      .theme-toggle {
        padding: 0.35rem 0.7rem;
        font-size: 0.72rem;
      }
    }

    .btn {
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      border: 1px solid rgba(248, 250, 252, 0.16);
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: inherit;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(to right, #ef4444, #f97316);
      border: none;
      color: #f9fafb;
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.55);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.35);
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
    }

    .theme-toggle span:first-child {
      font-size: 0.9rem;
    }

    /* CART BAR */

    .cart-bar {
      position: sticky;
      z-index: 49;
      padding: 0.45rem 0.85rem;
      background: rgba(248, 250, 252, 0.95);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      font-size: 0.75rem;
    }

    @media (min-width: 768px) {
      .cart-bar {
        padding-inline: 1.25rem;
      }
    }

    [data-theme="dark"] .cart-bar {
      background: rgba(2, 6, 23, 0.96);
      border-bottom-color: rgba(30, 64, 175, 0.7);
    }

    .cart-toggle {
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(255, 255, 255, 0.92);
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      cursor: pointer;
      font-size: 0.82rem;
      font-weight: 600;
      color: #111827;
      -webkit-tap-highlight-color: transparent;
    }

    [data-theme="dark"] .cart-toggle {
      background: rgba(15, 23, 42, 0.96);
      color: #f9fafb;
    }

    .cart-toggle .pill {
      background: var(--primary-soft);
      color: #b91c1c;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .cart-toggle .total {
      font-family: "Inter", system-ui;
      font-weight: 800;
      font-size: 0.88rem;
    }

    .cart-meta {
      font-size: 0.7rem;
      color: var(--muted);
      min-width: 0;
    }

    @media (max-width: 480px) {
      .cart-meta {
        display: none;
      }
    }

    /* STICKY MOBILE CART BAR (BOTTOM) */

    .cart-bar-bottom {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 51;
      display: none;
      padding: 0.5rem 0.75rem;
      background: rgba(15, 23, 42, 0.97);
      color: #f9fafb;
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(30, 64, 175, 0.85);
    }

    @media (max-width: 720px) {
      .cart-bar-bottom {
        display: flex;
      }
    }

    .cart-bar-bottom-inner {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .cart-bottom-summary {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      font-size: 0.8rem;
    }

    .cart-bottom-summary span:first-child {
      font-weight: 600;
    }

    .cart-bottom-summary span:last-child {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    .cart-bottom-btn {
      flex-shrink: 0;
      border-radius: 999px;
      padding: 0.55rem 1.1rem;
      border: none;
      background: linear-gradient(to right, #ef4444, #f97316);
      color: #f9fafb;
      font-size: 0.82rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(239, 68, 68, 0.7);
      -webkit-tap-highlight-color: transparent;
    }

    /* HERO */

    .hero {
      padding: 1.1rem 0.85rem 0.8rem;
    }

    @media (min-width: 768px) {
      .hero {
        padding-inline: 1.25rem;
      }
    }

    .hero-inner {
      max-width: 1100px;
      margin: 0 auto;
      background: radial-gradient(circle at top left, #fee2e2, #fefce8);
      border-radius: 24px;
      padding: 1.1rem 1rem 1rem;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    [data-theme="dark"] .hero-inner {
      background: radial-gradient(circle at top left, #111827, #020617);
    }

    .hero-inner::before {
      content: "";
      position: absolute;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, rgba(239, 68, 68, 0.3), transparent);
      top: -110px;
      right: -80px;
      filter: blur(3px);
      opacity: 0.7;
    }

    .hero-inner h2 {
      margin: 0 0 0.3rem;
      font-size: 1.35rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #111827;
    }

    [data-theme="dark"] .hero-inner h2 {
      color: #f9fafb;
    }

    .hero-inner p {
      margin: 0;
      font-size: 0.9rem;
      max-width: 42rem;
      color: var(--muted);
    }

    .hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
      align-items: center;
      margin-top: 0.7rem;
    }

    .hero-pill {
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.04);
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    [data-theme="dark"] .hero-pill {
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
    }

    /* SHOP SECTION */

    .shop-section {
      padding: 0.9rem 0.85rem 2.5rem;
    }

    @media (min-width: 768px) {
      .shop-section {
        padding-inline: 1.25rem;
      }
    }

    .section-header {
      max-width: 1100px;
      margin: 0 auto 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .section-header h2 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .section-header p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
      max-width: 40rem;
    }

    /* FILTERS / SEARCH / SORT */

    .shop-controls {
      max-width: 1100px;
      margin: 0 auto 0.75rem;
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 0.55rem;
      align-items: flex-end;
    }

    @media (max-width: 800px) {
      .shop-controls {
        grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      }
      .shop-controls .sort-wrap {
        grid-column: 1 / -1;
      }
    }

    @media (max-width: 560px) {
      .shop-controls {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .shop-field label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-bottom: 0.25rem;
      color: var(--muted);
    }

    .shop-field input,
    .shop-field select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.45rem 0.8rem;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.95);
      color: var(--text);
      outline: none;
      -webkit-appearance: none;
    }

    [data-theme="dark"] .shop-field input,
    [data-theme="dark"] .shop-field select {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(51, 65, 85, 0.9);
      color: #e5e7eb;
    }

    .shop-field input::placeholder {
      color: #9ca3af;
    }

    /* CATEGORY PILL FILTERS */

    .category-pills {
      max-width: 1100px;
      margin: 0 auto 0.75rem;
      display: flex;
      gap: 0.4rem;
      overflow-x: auto;
      padding-bottom: 0.1rem;
      -webkit-overflow-scrolling: touch;
    }

    .category-pill {
      flex: 0 0 auto;
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.78rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(255, 255, 255, 0.95);
      color: var(--muted);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .category-pill.active {
      background: linear-gradient(to right, #ef4444, #f97316);
      color: #f9fafb;
      border-color: transparent;
      box-shadow: 0 10px 22px rgba(239, 68, 68, 0.4);
    }

    [data-theme="dark"] .category-pill {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(55, 65, 81, 0.9);
      color: #d1d5db;
    }

    /* PRODUCT GRID */

    .product-grid {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.85rem;
    }

    @media (max-width: 1100px) {
      .product-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 800px) {
      .product-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 560px) {
      .product-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .product-card {
      background: var(--bg-alt);
      border-radius: var(--card-radius);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.22);
      border: 1px solid rgba(148, 163, 184, 0.28);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 160ms ease, box-shadow 160ms ease,
        border-color 160ms ease;
      position: relative;
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.3);
      border-color: rgba(239, 68, 68, 0.55);
    }

    .product-image-wrap {
      aspect-ratio: 4 / 3;
      overflow: hidden;
      position: relative;
      background: radial-gradient(circle at center, #f9fafb, #e5e7eb);
      cursor: pointer;
    }

    [data-theme="dark"] .product-image-wrap {
      background: radial-gradient(circle at center, #111827, #020617);
    }

    .product-image-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 220ms ease;
    }

    .product-card:hover .product-image-wrap img {
      transform: scale(1.04);
    }

    .product-badges {
      position: absolute;
      top: 0.55rem;
      left: 0.55rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      max-width: calc(100% - 1rem);
      z-index: 1;
    }

    .product-badge {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #111827;
      background: rgba(255, 255, 255, 0.95);
    }

    .badge-primary {
      background: linear-gradient(to right, #ef4444, #f97316);
      color: #f9fafb;
    }

    .badge-lowstock {
      background: rgba(234, 179, 8, 0.95);
      color: #111827;
    }

    .badge-category {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    .product-info {
      padding: 0.7rem 0.75rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.38rem;
      flex: 1;
    }

    .product-title {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .product-price-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .product-price {
      font-size: 1rem;
      font-weight: 800;
    }

    .product-price span {
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-left: 0.15rem;
    }

    .stock-pill {
      font-size: 0.7rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
      color: var(--muted);
      font-weight: 500;
    }

    .product-actions {
      margin-top: 0.4rem;
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
    }

    .product-actions .btn {
      flex: 1;
      justify-content: center;
      font-size: 0.78rem;
      padding-block: 0.4rem;
    }

    /* NO RESULTS */

    .no-results {
      max-width: 1100px;
      margin: 1rem auto 0;
      font-size: 0.9rem;
      color: var(--muted);
      padding: 0.8rem 0.9rem;
      border-radius: 999px;
      background: rgba(249, 250, 251, 0.95);
      border: 1px dashed rgba(148, 163, 184, 0.75);
    }

    [data-theme="dark"] .no-results {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(55, 65, 81, 0.95);
    }

    .hidden {
      display: none !important;
    }

    /* CART OVERLAY & PANEL */

    .cart-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.68);
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      z-index: 70;
    }

    .cart-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .cart-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(420px, 100%);
      background: radial-gradient(circle at top left, #fee2e2, #ffffff);
      box-shadow: -20px 0 50px rgba(15, 23, 42, 0.7);
      border-left: 1px solid rgba(148, 163, 184, 0.5);
      transform: translateX(100%);
      transition: transform 190ms ease;
      z-index: 71;
      display: flex;
      flex-direction: column;
    }

    [data-theme="dark"] .cart-panel {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-left-color: rgba(30, 64, 175, 0.8);
    }

    .cart-panel.open {
      transform: translateX(0);
    }

    .cart-panel-inner {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 0.9rem 0.85rem 0.9rem;
      gap: 0.65rem;
    }

    .cart-back-btn {
      align-self: flex-start;
      border-radius: 999px;
      border: none;
      background: rgba(15, 23, 42, 0.08);
      color: inherit;
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    [data-theme="dark"] .cart-back-btn {
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .cart-header h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .cart-header small {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding-right: 0.3rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      -webkit-overflow-scrolling: touch;
    }

    .cart-empty {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .cart-item-row {
      display: grid;
      grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.8fr);
      gap: 0.4rem;
      padding: 0.45rem;
      border-radius: 14px;
      background: rgba(248, 250, 252, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    [data-theme="dark"] .cart-item-row {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(51, 65, 85, 0.95);
    }

    @media (max-width: 480px) {
      .cart-item-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .cart-item-main {
      display: flex;
      gap: 0.4rem;
    }

    .cart-item-thumb {
      width: 62px;
      height: 62px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(148, 163, 184, 0.2);
      flex-shrink: 0;
    }

    .cart-item-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .cart-item-info {
      font-size: 0.8rem;
    }

    .cart-item-title {
      font-weight: 600;
      margin-bottom: 0.1rem;
    }

    .cart-item-sku {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .cart-item-price {
      font-size: 0.8rem;
      margin-top: 0.15rem;
    }

    .cart-item-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: space-between;
      gap: 0.3rem;
      font-size: 0.8rem;
    }

    .cart-qty-controls {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(15, 23, 42, 0.03);
      border-radius: 999px;
      padding: 0.12rem 0.3rem;
    }

    .qty-btn {
      width: 1.4rem;
      height: 1.4rem;
      border-radius: 999px;
      border: none;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    [data-theme="dark"] .qty-btn {
      background: rgba(30, 64, 175, 0.8);
      color: #f9fafb;
    }

    .cart-qty {
      min-width: 1.4rem;
      text-align: center;
      font-weight: 600;
    }

    .cart-line-total {
      font-weight: 700;
    }

    .cart-remove-btn {
      border: none;
      background: transparent;
      font-size: 0.7rem;
      color: #b91c1c;
      text-decoration: underline;
      text-underline-offset: 3px;
      cursor: pointer;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    .cart-summary {
      border-top: 1px solid rgba(148, 163, 184, 0.5);
      padding-top: 0.45rem;
      margin-top: 0.2rem;
      font-size: 0.85rem;
    }

    .cart-summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.15rem;
    }

    .cart-summary-row.total-row span:last-child {
      font-weight: 800;
      font-size: 0.95rem;
    }

    .checkout-form {
      margin-top: 0.4rem;
      padding: 0.45rem 0.55rem;
      border-radius: 14px;
      background: rgba(248, 250, 252, 0.97);
      border: 1px solid rgba(148, 163, 184, 0.65);
      font-size: 0.75rem;
    }

    [data-theme="dark"] .checkout-form {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(37, 99, 235, 0.85);
    }

    .checkout-form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
      margin-bottom: 0.35rem;
    }

    .checkout-form-row--3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
.payment-methods {
  margin-top: 0.6rem;
  padding-top: 0.5rem;
  border-top: 1px dashed rgba(148, 163, 184, 0.6);
  font-size: 0.75rem;
}

.payment-title {
  margin: 0;
  font-weight: 600;
}

.payment-buttons {
  margin-top: 0.35rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
}

.payment-btn {
  flex: 1;
  justify-content: center;
  font-size: 0.78rem;
  padding-block: 0.4rem;
}

.payment-hint {
  margin: 0.4rem 0 0;
  font-size: 0.7rem;
  color: var(--muted);
}
    @media (max-width: 480px) {
      .checkout-form-row,
      .checkout-form-row--3 {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .checkout-form label {
      display: block;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.1rem;
      color: var(--muted);
    }

    .checkout-form input,
    .checkout-form textarea {
      width: 100%;
      border-radius: 9px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.3rem 0.45rem;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.96);
      color: var(--text);
      outline: none;
    }

    [data-theme="dark"] .checkout-form input,
    [data-theme="dark"] .checkout-form textarea {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(51, 65, 85, 0.95);
      color: #e5e7eb;
    }

    .checkout-form textarea {
      min-height: 60px;
      resize: vertical;
    }

    /* SHIPPING / PICKUP TOGGLE */

    .checkout-shipping-toggle {
      display: flex;
      gap: 0.4rem;
      margin: 0.35rem 0 0.25rem;
      flex-wrap: wrap;
    }

    .shipping-option {
      position: relative;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 0.25rem 0.7rem;
      font-size: 0.72rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: rgba(255, 255, 255, 0.96);
    }

    .shipping-option input {
      display: none;
    }

    .shipping-option span {
      pointer-events: none;
    }

    .shipping-option.active {
      background: linear-gradient(to right, #ef4444, #f97316);
      color: #f9fafb;
      border-color: transparent;
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.45);
    }

    [data-theme="dark"] .shipping-option {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .shipping-address {
      margin-top: 0.25rem;
    }

    .shipping-rate-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.15rem;
    }

    .shipping-rate-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(255, 255, 255, 0.96);
      padding: 0.25rem 0.7rem;
      font-size: 0.72rem;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .shipping-rate-btn.active {
      background: linear-gradient(to right, #ef4444, #f97316);
      color: #f9fafb;
      border-color: transparent;
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.45);
    }

    [data-theme="dark"] .shipping-rate-btn {
      background: rgba(15, 23, 42, 0.98);
      border-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .checkout-form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.25rem;
    }

    .checkout-form-footer small {
      font-size: 0.65rem;
      color: var(--muted);
    }

    .cart-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
      margin-top: 0.2rem;
    }

    .cart-note {
      font-size: 0.75rem;
      color: var(--muted);
      margin: 0.35rem 0 0;
    }

    /* CHECKOUT MESSAGE */

    .checkout-message {
      position: fixed;
      bottom: 3.2rem;
      left: 50%;
      transform: translateX(-50%) translateY(120%);
      max-width: 520px;
      width: calc(100% - 1.5rem);
      background: #22c55e;
      color: #022c22;
      padding: 0.65rem 0.85rem;
      border-radius: 999px;
      font-size: 0.8rem;
      box-shadow: 0 16px 35px rgba(22, 163, 74, 0.6);
      z-index: 80;
      opacity: 0;
      transition: opacity 160ms ease, transform 160ms ease;
    }

    .checkout-message.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0%);
    }

    .checkout-message span {
      font-weight: 600;
    }

    /* PICKUP & FAQ */

    .pickup-section,
    .faq-section {
      padding: 0 0.85rem 2rem;
    }

    @media (min-width: 768px) {
      .pickup-section,
      .faq-section {
        padding-inline: 1.25rem;
      }
    }

    .pickup-content,
    .faq-grid {
      max-width: 1100px;
      margin: 0.6rem auto 0;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.7rem;
    }

    @media (max-width: 840px) {
      .pickup-content,
      .faq-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .pickup-content,
      .faq-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .pickup-card,
    .faq-item {
      background: var(--bg-alt);
      border-radius: 18px;
      padding: 0.8rem 0.8rem 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.8rem;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.16);
    }

    [data-theme="dark"] .pickup-card,
    [data-theme="dark"] .faq-item {
      background: #020617;
      border-color: rgba(30, 64, 175, 0.75);
    }

    .pickup-card h3,
    .faq-item h3 {
      margin: 0 0 0.25rem;
      font-size: 0.9rem;
    }

    .pickup-card p,
    .faq-item p {
      margin: 0;
      color: var(--muted);
    }

    .pickup-card ol {
      margin: 0.25rem 0 0;
      padding-left: 1.2rem;
      color: var(--muted);
    }

    .pickup-card li {
      margin-bottom: 0.1rem;
    }

    /* FOOTER */

    .site-footer {
      padding: 1rem 0.85rem 1.2rem;
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(248, 250, 252, 0.96);
      margin-bottom: 2.6rem;
    }

    @media (min-width: 768px) {
      .site-footer {
        padding-inline: 1.25rem;
        margin-bottom: 0;
      }
    }

    [data-theme="dark"] .site-footer {
      background: #020617;
      border-top-color: rgba(30, 64, 175, 0.8);
    }

    .footer-small {
      margin-top: 0.2rem;
      font-size: 0.7rem;
      opacity: 0.9;
    }

    /* MODAL */

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      opacity: 0;
      pointer-events: none;
      z-index: 75;
      transition: opacity 160ms ease;
    }

    .modal.open {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-dialog {
      max-width: 680px;
      width: 100%;
      background: var(--bg-alt);
      border-radius: 20px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.55);
      overflow: hidden;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      max-height: min(520px, 100vh - 3rem);
    }

    @media (max-width: 720px) {
      .modal-dialog {
        grid-template-columns: minmax(0, 1fr);
        max-height: min(600px, 100vh - 2rem);
      }
    }

    [data-theme="dark"] .modal-dialog {
      background: #020617;
      border-color: rgba(30, 64, 175, 0.75);
    }

    .modal-media {
      background: radial-gradient(circle at center, #f9fafb, #e5e7eb);
      position: relative;
    }

    [data-theme="dark"] .modal-media {
      background: radial-gradient(circle at center, #111827, #020617);
    }

    .modal-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-body {
      padding: 0.85rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.85rem;
      overflow-y: auto;
    }

    .modal-close {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      z-index: 1;
      background: rgba(15, 23, 42, 0.8);
      color: #f9fafb;
      border-radius: 999px;
      border: none;
      width: 1.9rem;
      height: 1.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .modal-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
    }

    .modal-sku {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .modal-price {
      font-size: 1rem;
      font-weight: 800;
      margin-top: 0.2rem;
    }

    .modal-description {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.3rem;
    }

    .modal-thumbs {
      margin-top: 0.45rem;
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }

    .modal-thumb {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.65);
      cursor: pointer;
      background: rgba(148, 163, 184, 0.2);
      -webkit-tap-highlight-color: transparent;
    }

    .modal-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-actions {
      margin-top: 0.4rem;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .modal-actions .btn {
      flex: 1;
      justify-content: center;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="site-header" id="top">
    <a class="brand" href="#top">
      <img src="img/flashbidz_logo.svg" alt="FlashBidz" class="logoimg" />
      <div class="name">
        <h1>FlashBidz Store</h1>
        <p class="tagline">Neighbors Helping Neighbors ‚Ä¢ Mattawan, MI</p>
      </div>
    </a>
    <nav class="top-cta">
      <button id="theme-toggle" class="theme-toggle" type="button">
        <span>‚òÄÔ∏è</span>
        <span id="theme-label">Light</span>
      </button>
      <a class="btn btn-primary" href="#shop">Shop</a>
      <a class="btn btn-ghost" href="#pickup">Pickup Info</a>
      <a
        class="btn"
        href="https://www.facebook.com/flashbidz.mattawan"
        target="_blank"
        rel="noopener"
      >
        üí¨ Facebook
      </a>
    </nav>
  </header>

  <!-- TOP CART BAR -->
  <section class="cart-bar">
    <button id="cart-toggle" class="cart-toggle" type="button">
      <span class="pill">
        Cart ‚Ä¢ <span id="cart-count">0</span> item<span id="cart-count-s">s</span>
      </span>
      <span class="total" id="cart-total">$0.00</span>
    </button>
    <div class="cart-meta">
      Fixed-price deals ‚Ä¢ Sold-out items are removed from this page.
    </div>
  </section>

  <!-- BOTTOM CART BAR (MOBILE) -->
  <div class="cart-bar-bottom">
    <div class="cart-bar-bottom-inner">
      <div class="cart-bottom-summary">
        <span><span id="cart-count-bottom">0</span> item<span id="cart-count-bottom-s">s</span> in cart</span>
        <span>Total: <strong id="cart-total-bottom-bar">$0.00</strong></span>
      </div>
      <button class="cart-bottom-btn" type="button" id="cart-bottom-btn">
        View Cart / Checkout ‚Üí
      </button>
    </div>
  </div>

  <!-- CHECKOUT STATUS BAR -->
  <div id="checkout-message" class="checkout-message hidden"></div>

  <!-- CART OVERLAY + PANEL -->
  <div id="cart-overlay" class="cart-overlay" aria-hidden="true"></div>

  <aside
    id="cart-panel"
    class="cart-panel"
    aria-hidden="true"
    aria-labelledby="cart-title"
  >
    <div class="cart-panel-inner">
      <button id="cart-back-btn" class="cart-back-btn" type="button">
        ‚Üê Back to shopping
      </button>

      <header class="cart-header">
        <div>
          <h2 id="cart-title">Your Cart</h2>
          <small id="cart-meta-small">No items yet.</small>
        </div>
      </header>

      <div id="cart-items" class="cart-items"></div>

      <div class="cart-summary">
        <div class="cart-summary-row">
          <span>Subtotal</span>
          <span id="cart-subtotal">$0.00</span>
        </div>
        <div class="cart-summary-row">
          <span>Sales Tax (6%)</span>
          <span id="cart-tax">$0.00</span>
        </div>
        <div class="cart-summary-row">
          <span>Shipping</span>
          <span id="cart-shipping">$0.00</span>
        </div>
        <div class="cart-summary-row total-row">
          <span>Total</span>
          <span id="cart-total-bottom">$0.00</span>
        </div>
      </div>

      <div class="checkout-form">
        <div class="checkout-form-row">
          <div>
            <label for="checkout-name">Name</label>
            <input id="checkout-name" type="text" placeholder="Your name" />
          </div>
          <div>
            <label for="checkout-contact">Best way to reach you</label>
            <input
              id="checkout-contact"
              type="text"
              placeholder="Phone, email, or Facebook name"
            />
          </div>
        </div>

        <!-- PICKUP vs SHIPPING -->
        <div class="checkout-shipping-toggle">
          <label class="shipping-option active">
            <input
              type="radio"
              name="checkout-fulfillment"
              value="pickup"
              id="fulfillment-pickup"
              checked
            />
            <span>Local Pickup</span>
          </label>
          <label class="shipping-option">
            <input
              type="radio"
              name="checkout-fulfillment"
              value="shipping"
              id="fulfillment-shipping"
            />
            <span>Ship to Me</span>
          </label>
        </div>

        <!-- SHIPPING ADDRESS (shown only if "Ship to Me" is selected) -->
        <div id="shipping-fields" class="shipping-address hidden">
          <div class="checkout-form-row">
            <div>
              <label for="shipping-address1">Street address</label>
              <input
                id="shipping-address1"
                type="text"
                placeholder="123 Main St"
              />
            </div>
            <div>
              <label for="shipping-address2">Apt / Suite (optional)</label>
              <input
                id="shipping-address2"
                type="text"
                placeholder="Apt, suite, etc."
              />
            </div>
          </div>
          <div class="checkout-form-row checkout-form-row--3">
            <div>
              <label for="shipping-city">City</label>
              <input id="shipping-city" type="text" placeholder="Mattawan" />
            </div>
            <div>
              <label for="shipping-state">State</label>
              <input id="shipping-state" type="text" maxlength="2" placeholder="MI" />
            </div>
            <div>
              <label for="shipping-zip">ZIP</label>
              <input id="shipping-zip" type="text" placeholder="49071" />
            </div>
          </div>
          <div class="checkout-form-row">
            <div>
              <label>Flat-rate shipping</label>
              <div class="shipping-rate-options">
                <button type="button" class="shipping-rate-btn" data-amount="8">$8 (small)</button>
                <button type="button" class="shipping-rate-btn" data-amount="12">$12 (medium)</button>
                <button type="button" class="shipping-rate-btn" data-amount="18">$18 (large)</button>
              </div>
            </div>
          </div>
        </div>

        <div>
          <label for="checkout-notes">Notes</label>
          <textarea
            id="checkout-notes"
            placeholder="Pickup timing, shipping questions, or anything else."
          ></textarea>
        </div>
        <div class="checkout-form-footer">
          <small>
            After you submit, you‚Äôll see your total (with tax and shipping if selected)
            and payment info for Cash App / Venmo.
          </small>
          <button id="checkout-btn" class="btn btn-primary btn-sm" type="button">
            Submit Cart
          </button>
        </div>
      </div>
<div class="payment-methods">
  <p class="payment-title">Pay online (Cash App or Venmo)</p>
  <div class="payment-buttons">
    <button id="pay-cashapp-btn" class="btn payment-btn" type="button">
      Pay with Cash App
    </button>
    <button id="pay-venmo-btn" class="btn payment-btn" type="button">
      Pay with Venmo
    </button>
  </div>
  <p class="payment-hint">
    Amount is based on your cart total. We‚Äôll match your payment using your name and contact info.
  </p>
</div>
      <div class="cart-actions">
        <button id="clear-cart-btn" class="btn btn-link" type="button">
          Clear cart
        </button>
      </div>

      <p class="cart-note">
        Pickup at FlashBidz in Mattawan, MI or simple flat-rate shipping on many items.
      </p>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main>
    <!-- HERO -->
    <section class="hero">
      <div class="hero-inner">
        <h2>In-Stock Deals ‚Ä¢ Pickup & Shipping</h2>
        <p>
          Everything on this page is ready now ‚Äî no auctions and no countdowns.
          Add items to your cart and submit when you‚Äôre ready. You‚Äôll see your
          total (with 6% sales tax and any flat-rate shipping) and can pay online.
        </p>
        <div class="hero-actions">
          <a class="btn btn-primary" href="#shop">Start Shopping</a>
          <a class="btn btn-ghost" href="#pickup">Pickup Details</a>
          <span class="hero-pill">
            ‚ö° Live inventory ‚Äî when it‚Äôs gone, it‚Äôs gone
          </span>
        </div>
      </div>
    </section>

    <!-- SHOP SECTION -->
    <section id="shop" class="shop-section">
      <header class="section-header">
        <h2>Shop Available Items</h2>
        <p>
          Quantities are limited. If an item sells out, it disappears from this
          page so you don‚Äôt accidentally add it to your cart.
        </p>
      </header>

      <!-- SEARCH / FILTER / SORT -->
      <div class="shop-controls">
        <div class="shop-field">
          <label for="search-input">Search</label>
          <input
            id="search-input"
            type="search"
            placeholder="Search by keyword, SKU, or description‚Ä¶"
            autocomplete="off"
          />
        </div>
        <div class="shop-field">
          <label for="filter-category">Category</label>
          <select id="filter-category">
            <option value="all">All</option>
          </select>
        </div>
        <div class="shop-field sort-wrap">
          <label for="sort-select">Sort</label>
          <select id="sort-select">
            <option value="featured">Featured</option>
            <option value="newest">Newest first</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="title-asc">Title: A ‚Üí Z</option>
          </select>
        </div>
      </div>

      <!-- CATEGORY PILL FILTERS -->
      <div id="category-pills" class="category-pills">
        <!-- pills added by JS -->
      </div>

      <!-- PRODUCT GRID -->
      <div id="product-grid" class="product-grid"></div>

      <p id="no-results" class="no-results hidden">
        No items match your filters right now. Try clearing search and filters,
        or check back soon ‚Äî new deals are added regularly!
      </p>
    </section>

    <!-- PICKUP INFO -->
    <section id="pickup" class="pickup-section">
      <header class="section-header">
        <h2>Pickup Info</h2>
      </header>
      <div class="pickup-content">
        <div class="pickup-card">
          <h3>Location</h3>
          <p>
            FlashBidz Store<br />
            51797 County Road 652<br />
            Mattawan, MI 49071
          </p>
        </div>

        <div class="pickup-card">
          <h3>How It Works</h3>
          <ol>
            <li>Add items to your cart and submit it.</li>
            <li>You‚Äôll see your full total including 6% sales tax and any shipping.</li>
            <li>
              Pay via Cash App or Venmo and we‚Äôll have your items ready for pickup
              (or ship them if you chose shipping).
            </li>
          </ol>
        </div>

        <div class="pickup-card">
          <h3>Questions?</h3>
          <p>
            Message us on Facebook via the button at the top of this page or
            search ‚ÄúFlashBidz of Mattawan‚Äù on Facebook.
          </p>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section class="faq-section">
      <header class="section-header">
        <h2>Good to Know</h2>
      </header>
      <div class="faq-grid">
        <div class="faq-item">
          <h3>Are these auction items?</h3>
          <p>
            Nope! Everything here is fixed-price store inventory. Auctions still
            run separately on FlashBidz ‚Äî this page is for instant ‚Äúbuy it now‚Äù
            deals.
          </p>
        </div>
        <div class="faq-item">
          <h3>What if something is sold out?</h3>
          <p>
            When we mark an item as sold out, it disappears from this page.
            If you don‚Äôt see it here, it‚Äôs already spoken for.
          </p>
        </div>
        <div class="faq-item">
          <h3>Can I combine with auction pickups?</h3>
          <p>
            Usually yes! If you have auction wins and store items at the same
            time, we‚Äôll do our best to bundle them into one pickup.
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <p>
      &copy; <span id="year"></span> FlashBidz LLC ‚Ä¢ Mattawan, Michigan
    </p>
    <p class="footer-small">
      Built by local sellers ‚Ä¢ Fueled by local shoppers
    </p>
  </footer>

<!--
<audio id="add-to-cart-sound" preload="auto">
  <source src="sounds/add-to-cart.mp3" type="audio/mpeg" />
</audio>

<audio id="remove-from-cart-sound" preload="auto">
  <source src="sounds/remove-from-cart.mp3" type="audio/mpeg" />
</audio>
-->
  <!-- PRODUCT DETAILS MODAL -->
  <div id="product-modal" class="modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-media">
        <button class="modal-close" type="button" aria-label="Close">
          ‚úï
        </button>
        <img id="modal-main-image" src="" alt="" />
      </div>
      <div class="modal-body">
        <h3 class="modal-title" id="modal-title"></h3>
        <div class="modal-sku" id="modal-sku"></div>
        <div class="modal-price" id="modal-price"></div>
        <div class="modal-description" id="modal-description"></div>
        <div class="modal-thumbs" id="modal-thumbs"></div>
        <div class="modal-actions">
          <button id="modal-add-to-cart" class="btn btn-primary" type="button">
            Add to Cart
          </button>
          <button id="modal-close-btn" class="btn btn-ghost" type="button">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN SCRIPT -->
  <script>
    const CART_STORAGE_KEY = "flashbidz_cart_v3";
    const THEME_STORAGE_KEY = "flashbidz_theme";
    const TAX_RATE = 0.06;
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzowPxsTHcKnd3g8OKcwUffksJGEp9QfwLgJSg7NkcpuIsm4-ke4zOM1Gg-qUJwhru8/exec";
    let allProducts = [];
    let filteredProducts = [];
    let cart = [];
    let shippingAmount = 0;
    let currentCartTotal = 0;
    let lastOrderId = "";
    let checkoutSubmitted = false;
    let lastSubmittedTotal = 0;  
const LAST_TOTAL_KEY = "flashbidz_last_submitted_total_v1";

function setLastSubmittedTotal(amount) {
  const val = Number(amount || 0);
  lastSubmittedTotal = val;
  try { localStorage.setItem(LAST_TOTAL_KEY, String(val)); } catch (_) {}
}

function loadLastSubmittedTotal() {
  try {
    const saved = Number(localStorage.getItem(LAST_TOTAL_KEY) || 0);
    if (saved > 0) lastSubmittedTotal = saved;
  } catch (_) {}
}

function clearAmountDue() {
  lastSubmittedTotal = 0;
  try { localStorage.removeItem(LAST_TOTAL_KEY); } catch (_) {}
  updateCartSummary();
}

function getPayTotal() {
  // If cart has items, pay total is current cart total
  if (cart && cart.length) return Number(currentCartTotal || 0);

  // If cart is empty, use last submitted total
  return Number(lastSubmittedTotal || 0);
}

function getOrderId_() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  const rand = Math.random().toString(36).slice(2, 7).toUpperCase();
  return `FBZ-${y}${m}${day}-${rand}`;
}
    // for the product modal image gallery
    let currentModalImages = [];
    let currentModalImageIndex = 0;

    const el = {};

    document.addEventListener("DOMContentLoaded", () => {
      cacheDom();
      initTheme();
      bindEvents();
      loadCartFromStorage();
      loadLastSubmittedTotal();
      loadProducts();
      setCurrentYear();
      handleFulfillmentChange();
      setPayButtonsEnabled(false);
      renderPaymentDue();
    });
function setPayButtonsEnabled(enabled) {
  [el.payCashAppBtn, el.payVenmoBtn].forEach((btn) => {
    if (!btn) return;
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? "1" : "0.45";
    btn.style.cursor = enabled ? "pointer" : "not-allowed";
  });
}

function clearAmountDue() {
  lastSubmittedTotal = 0;
  try { localStorage.removeItem(LAST_TOTAL_KEY); } catch (_) {}
  updateCartSummary();
}    
  
  function updatePayButtonLabels() {
  const amount = Number(lastSubmittedTotal || 0);
  if (!amount) return;

  const label = `$${amount.toFixed(2)}`;

  if (el.payCashAppBtn) {
    el.payCashAppBtn.textContent = `Pay ${label} with Cash App`;
  }

  if (el.payVenmoBtn) {
    el.payVenmoBtn.textContent = `Pay ${label} with Venmo`;
  }
}
    
    function cacheDom() {
      el.productGrid = document.getElementById("product-grid");
      el.noResults = document.getElementById("no-results");
      el.searchInput = document.getElementById("search-input");
      el.filterCategory = document.getElementById("filter-category");
      el.sortSelect = document.getElementById("sort-select");
      el.categoryPills = document.getElementById("category-pills");

      el.cartToggle = document.getElementById("cart-toggle");
      el.cartBackBtn = document.getElementById("cart-back-btn");
      el.cartPanel = document.getElementById("cart-panel");
      el.cartOverlay = document.getElementById("cart-overlay");
      el.cartItems = document.getElementById("cart-items");
      el.cartSubtotal = document.getElementById("cart-subtotal");
      el.cartTotalBottom = document.getElementById("cart-total-bottom");
      el.cartCount = document.getElementById("cart-count");
      el.cartCountS = document.getElementById("cart-count-s");
      el.cartCountBottom = document.getElementById("cart-count-bottom");
      el.cartCountBottomS = document.getElementById("cart-count-bottom-s");
      el.cartTotalTop = document.getElementById("cart-total");
      el.cartTotalBottomBar = document.getElementById("cart-total-bottom-bar");
      el.cartMetaSmall = document.getElementById("cart-meta-small");
      el.cartTax = document.getElementById("cart-tax");
      el.cartShipping = document.getElementById("cart-shipping");

      el.clearCartBtn = document.getElementById("clear-cart-btn");
      el.checkoutBtn = document.getElementById("checkout-btn");
      el.checkoutMessage = document.getElementById("checkout-message");

      el.checkoutName = document.getElementById("checkout-name");
      el.checkoutContact = document.getElementById("checkout-contact");
      el.checkoutNotes = document.getElementById("checkout-notes");
      
      el.payCashAppBtn = document.getElementById("pay-cashapp-btn");
      el.payVenmoBtn = document.getElementById("pay-venmo-btn");
      
      // fulfillment + shipping fields
      el.fulfillmentPickup = document.getElementById("fulfillment-pickup");
      el.fulfillmentShipping = document.getElementById("fulfillment-shipping");
      el.shippingFields = document.getElementById("shipping-fields");
      el.shippingAddress1 = document.getElementById("shipping-address1");
      el.shippingAddress2 = document.getElementById("shipping-address2");
      el.shippingCity = document.getElementById("shipping-city");
      el.shippingState = document.getElementById("shipping-state");
      el.shippingZip = document.getElementById("shipping-zip");
      el.shippingRateButtons = document.querySelectorAll(".shipping-rate-btn");

      el.addToCartSound = document.getElementById("add-to-cart-sound");

      el.themeToggle = document.getElementById("theme-toggle");
      el.themeLabel = document.getElementById("theme-label");

      el.cartBottomBtn = document.getElementById("cart-bottom-btn");

      el.modal = document.getElementById("product-modal");
      el.modalClose = el.modal?.querySelector(".modal-close");
      el.modalCloseBtn = document.getElementById("modal-close-btn");
      el.modalMainImage = document.getElementById("modal-main-image");
      el.modalTitle = document.getElementById("modal-title");
      el.modalSku = document.getElementById("modal-sku");
      el.modalPrice = document.getElementById("modal-price");
      el.modalDescription = document.getElementById("modal-description");
      el.modalThumbs = document.getElementById("modal-thumbs");
      el.modalAddToCart = document.getElementById("modal-add-to-cart");
    }

    function bindEvents() {
      el.searchInput?.addEventListener("input", applyFilters);
      el.filterCategory?.addEventListener("change", applyFilters);
      el.sortSelect?.addEventListener("change", applyFilters);

      el.cartToggle?.addEventListener("click", () => setCartOpen(true));
      el.cartBackBtn?.addEventListener("click", () => setCartOpen(false));
      el.cartOverlay?.addEventListener("click", () => setCartOpen(false));
      el.cartBottomBtn?.addEventListener("click", () => setCartOpen(true));

      el.clearCartBtn?.addEventListener("click", clearCart);
      el.checkoutBtn?.addEventListener("click", handleCheckout);
      el.payCashAppBtn?.addEventListener("click", handleCashAppPay);
      el.payVenmoBtn?.addEventListener("click", handleVenmoPay);
      el.themeToggle?.addEventListener("click", toggleTheme);

      // fulfillment selection
      el.fulfillmentPickup?.addEventListener("change", handleFulfillmentChange);
      el.fulfillmentShipping?.addEventListener("change", handleFulfillmentChange);

      // flat-rate shipping buttons
      el.shippingRateButtons?.forEach((btn) => {
        btn.addEventListener("click", () => {
          const amount = Number(btn.dataset.amount || 0);
          setShippingAmount(amount);
        });
      });

      if (el.modal) {
        el.modal.addEventListener("click", (e) => {
          if (e.target === el.modal) {
            closeModal();
          }
        });
      }
      el.modalClose?.addEventListener("click", closeModal);
      el.modalCloseBtn?.addEventListener("click", closeModal);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeModal();
          setCartOpen(false);
        }
      });

      el.modalAddToCart?.addEventListener("click", () => {
        if (!el.modal.dataset.sku) return;
        const product = allProducts.find((p) => p.sku === el.modal.dataset.sku);
        if (product) {
          addToCart(product);
          playAddToCartSound();
          closeModal();
        }
      });
    }

async function loadProducts() {
  if (!el.productGrid) return;

  const url = APPS_SCRIPT_URL + "?action=products&t=" + Date.now();
  console.log("Loading products from:", url);

  try {
    const response = await fetch(url, { cache: "no-store" });
    if (!response.ok) throw new Error("HTTP " + response.status);

    const data = await response.json();
    console.log("Products raw response:", data);

    const products = Array.isArray(data?.products) ? data.products : [];

    if (!products.length) {
      el.productGrid.innerHTML = "<p>No products found.</p>";
      allProducts = [];
      filteredProducts = [];
      return;
    }

    // Only show active items with stock > 0
    allProducts = products.filter((p) => {
      const active = p.active !== false;
      const hasStock = p.stock === undefined || Number(p.stock) > 0;
      return active && hasStock;
    });

    buildCategoryOptions(allProducts);
    buildCategoryPills(allProducts);

    const withIndex = allProducts.map((p, idx) => ({ ...p, __index: idx }));
    filteredProducts = sortProducts(withIndex, el.sortSelect?.value || "featured");
    renderProducts(filteredProducts);

  } catch (err) {
    console.error("Error loading products:", err);

    // This message will show on the page so you don‚Äôt stare at a blank grid
    el.productGrid.innerHTML =
      "<p>Could not load products. Open DevTools ‚Üí Console. If you see a CORS error, tell me.</p>";
  }
}
    function buildCategoryOptions(products) {
      if (!el.filterCategory) return;

      const categories = new Set();
      products.forEach((p) => {
        if (Array.isArray(p.categories)) {
          p.categories.forEach((c) => categories.add(c));
        }
      });

      el.filterCategory.innerHTML = '<option value="all">All</option>';
      [...categories]
        .filter(Boolean)
        .sort()
        .forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          el.filterCategory.appendChild(opt);
        });
    }

    function buildCategoryPills(products) {
      if (!el.categoryPills) return;

      const categories = new Set();
      products.forEach((p) => {
        if (Array.isArray(p.categories)) {
          p.categories.forEach((c) => categories.add(c));
        }
      });

      el.categoryPills.innerHTML = "";

      const allPill = document.createElement("button");
      allPill.type = "button";
      allPill.className = "category-pill active";
      allPill.dataset.category = "all";
      allPill.textContent = "All";
      allPill.addEventListener("click", () => {
        setCategoryFilterFromPill("all");
      });
      el.categoryPills.appendChild(allPill);

      [...categories]
        .filter(Boolean)
        .sort()
        .forEach((cat) => {
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "category-pill";
          pill.dataset.category = cat;
          pill.textContent = cat;
          pill.addEventListener("click", () => {
            setCategoryFilterFromPill(cat);
          });
          el.categoryPills.appendChild(pill);
        });
    }

    function setCategoryFilterFromPill(category) {
      if (el.filterCategory) {
        el.filterCategory.value = category === "all" ? "all" : category;
      }

      if (el.categoryPills) {
        el.categoryPills.querySelectorAll(".category-pill").forEach((pill) => {
          pill.classList.toggle("active", pill.dataset.category === category);
        });
      }

      applyFilters();
    }

    function sortProducts(list, sortValue) {
      const arr = [...list];
      switch (sortValue) {
        case "newest":
          arr.sort((a, b) => {
            const da = new Date(a.added_at || 0).getTime();
            const db = new Date(b.added_at || 0).getTime();
            return db - da;
          });
          break;
        case "price-asc":
          arr.sort(
            (a, b) => Number(a.price || 0) - Number(b.price || 0)
          );
          break;
        case "price-desc":
          arr.sort(
            (a, b) => Number(b.price || 0) - Number(a.price || 0)
          );
          break;
        case "title-asc":
          arr.sort((a, b) =>
            (a.title || "").localeCompare(b.title || "")
          );
          break;
        case "featured":
        default:
          arr.sort((a, b) => (a.__index || 0) - (b.__index || 0));
      }
      return arr;
    }

    function renderProducts(list) {
      if (!el.productGrid) return;

      el.productGrid.innerHTML = "";

      if (!list.length) {
        el.noResults && el.noResults.classList.remove("hidden");
        return;
      } else {
        el.noResults && el.noResults.classList.add("hidden");
      }

      list.forEach((product) => {
        const card = document.createElement("div");
        card.className = "product-card";

        const price = Number(product.price || 0).toFixed(2);
        const stock = product.stock ?? 1;

        const badgesHtml = buildBadges(product, stock);
        const primaryImage = product.image ||
          (product.images && product.images[0]) ||
          "img/placeholder.png";

        card.innerHTML = `
          <div class="product-image-wrap">
            ${badgesHtml}
            <img src="${primaryImage}" alt="${escapeHtml(product.title || "")}">
          </div>
          <div class="product-info">
            <h3 class="product-title">${escapeHtml(product.title || "")}</h3>
            <div class="product-price-row">
              <div class="product-price">$${price} <span>each</span></div>
              <div class="stock-pill">${stock > 1 ? stock + " available" : "Last one"}</div>
            </div>
            <div class="product-actions">
              <button class="btn btn-primary add-to-cart-btn" data-sku="${product.sku}">
                Add to Cart
              </button>
              <button class="btn btn-ghost view-details-btn" data-sku="${product.sku}">
                Details
              </button>
            </div>
          </div>
        `;

        const addBtn = card.querySelector(".add-to-cart-btn");
        addBtn.addEventListener("click", () => {
          addToCart(product);
          playAddToCartSound();
        });

        const detailsBtn = card.querySelector(".view-details-btn");
        detailsBtn.addEventListener("click", () => {
          openProductModal(product);
        });

        const imageWrap = card.querySelector(".product-image-wrap");
        if (imageWrap) {
          imageWrap.addEventListener("click", () => {
            openProductModal(product);
          });
        }

        el.productGrid.appendChild(card);
      });
    }

    function buildBadges(product, stock) {
      const badges = [];

      if (product.badge && String(product.badge).trim() !== "") {
        badges.push(
          `<span class="product-badge badge-primary">${escapeHtml(
            String(product.badge)
          )}</span>`
        );
      } else if (product.added_at) {
        const added = new Date(product.added_at);
        const daysAgo =
          (Date.now() - added.getTime()) / (1000 * 60 * 60 * 24);
        if (!Number.isNaN(daysAgo) && daysAgo <= 7) {
          badges.push(
            '<span class="product-badge badge-primary">New</span>'
          );
        }
      }

      if (stock === 1) {
        badges.push(
          '<span class="product-badge badge-lowstock">Last one</span>'
        );
      } else if (stock > 1 && stock <= 3) {
        badges.push(
          '<span class="product-badge badge-lowstock">Low stock</span>'
        );
      }

      if (Array.isArray(product.categories) && product.categories[0]) {
        badges.push(
          `<span class="product-badge badge-category">${escapeHtml(
            product.categories[0]
          )}</span>`
        );
      }

      if (!badges.length) return "";
      return `<div class="product-badges">${badges.join("")}</div>`;
    }

    function applyFilters() {
      const searchTerm = (el.searchInput?.value || "").toLowerCase().trim();
      const category = el.filterCategory?.value || "all";
      const sortValue = el.sortSelect?.value || "featured";

      let list = allProducts.filter((p) => {
        const matchesSearch =
          !searchTerm ||
          (p.title && p.title.toLowerCase().includes(searchTerm)) ||
          (p.description &&
            p.description.toLowerCase().includes(searchTerm)) ||
          (p.sku && p.sku.toLowerCase().includes(searchTerm));

        const matchesCategory =
          category === "all" ||
          (Array.isArray(p.categories) &&
            p.categories.includes(category));

        return matchesSearch && matchesCategory;
      });

      // Hide any products that have gone out of stock client-side
      list = list.filter((p) => p.stock === undefined || p.stock > 0);

      list = list.map((p, idx) => ({ ...p, __index: idx }));
      filteredProducts = sortProducts(list, sortValue);
      renderProducts(filteredProducts);

      if (el.categoryPills) {
        const activeCat = category === "all" ? "all" : category;
        el.categoryPills.querySelectorAll(".category-pill").forEach((pill) => {
          pill.classList.toggle("active", pill.dataset.category === activeCat);
        });
      }
    }

    function addToCart(product) {
      const existing = cart.find((item) => item.sku === product.sku);
      const price = Number(product.price || 0);
      const image =
        product.image ||
        (Array.isArray(product.images) && product.images[0]) ||
        "img/placeholder.png";
      const maxQty = typeof product.stock === "number" ? product.stock : Infinity;

      if (existing) {
        if (existing.quantity >= maxQty && maxQty !== Infinity) {
          alert("Only " + maxQty + " of this item is available.");
          return;
        }
        existing.quantity += 1;
      } else {
        if (maxQty <= 0) {
          alert("This item is sold out.");
          return;
        }
        cart.push({
          sku: product.sku,
          title: product.title,
          price,
          image,
          quantity: 1,
        });
      }

      saveCartToStorage();
      renderCart();
      setCartOpen(true);
    }

    function removeFromCart(sku) {
      cart = cart.filter((item) => item.sku !== sku);
      saveCartToStorage();
      renderCart();
    }

    function updateCartQuantity(sku, delta) {
      const item = cart.find((i) => i.sku === sku);
      if (!item) return;

      const product = allProducts.find((p) => p.sku === sku);
      const maxQty = product && typeof product.stock === "number"
        ? product.stock
        : Infinity;

      if (delta > 0 && item.quantity >= maxQty && maxQty !== Infinity) {
        alert("Only " + maxQty + " of this item is available.");
        return;
      }

      item.quantity += delta;
      if (item.quantity <= 0) {
        cart = cart.filter((i) => i.sku !== sku);
      }

      saveCartToStorage();
      renderCart();
    }

    function clearCart() {
      if (!cart.length) return;
      if (!confirm("Clear all items from your cart?")) return;
      cart = [];
      saveCartToStorage();
      renderCart();
    }

    function renderCart() {
      if (!el.cartItems) return;

      el.cartItems.innerHTML = "";

      if (!cart.length) {
        el.cartItems.innerHTML =
          '<p class="cart-empty">Your cart is empty.</p>';
        if (el.cartMetaSmall) el.cartMetaSmall.textContent = "No items yet.";
      } else {
        cart.forEach((item) => {
          const row = document.createElement("div");
          row.className = "cart-item-row";

          const price = item.price.toFixed(2);
          const lineTotal = (item.price * item.quantity).toFixed(2);

          row.innerHTML = `
            <div class="cart-item-main">
              <div class="cart-item-thumb">
                <img src="${item.image}" alt="${escapeHtml(item.title)}">
              </div>
              <div class="cart-item-info">
                <div class="cart-item-title">${escapeHtml(item.title)}</div>
                <div class="cart-item-sku">SKU: ${item.sku}</div>
                <div class="cart-item-price">$${price}</div>
              </div>
            </div>
            <div class="cart-item-actions">
              <div class="cart-qty-controls">
                <button class="qty-btn" data-sku="${item.sku}" data-delta="-1">‚àí</button>
                <span class="cart-qty">${item.quantity}</span>
                <button class="qty-btn" data-sku="${item.sku}" data-delta="1">+</button>
              </div>
              <div class="cart-line-total">$${lineTotal}</div>
              <button class="cart-remove-btn" data-sku="${item.sku}">Remove</button>
            </div>
          `;

          row.querySelectorAll(".qty-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const s = btn.getAttribute("data-sku");
              const d = Number(btn.getAttribute("data-delta") || 0);
              updateCartQuantity(s, d);
            });
          });

          const removeBtn = row.querySelector(".cart-remove-btn");
          removeBtn.addEventListener("click", () => {
            const s = removeBtn.getAttribute("data-sku");
            removeFromCart(s);
          });

          el.cartItems.appendChild(row);
        });

        if (el.cartMetaSmall) {
          const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
          el.cartMetaSmall.textContent = `${itemCount} item${
            itemCount === 1 ? "" : "s"
          } in cart`;
        }
      }

      updateCartSummary();
    }

  // ‚úÖ Pay buttons ALWAYS show Amount Due if it exists (even if cart has items)
  const amountDue = Number(lastSubmittedTotal || 0);

  if (amountDue > 0) {
    const label = `$${amountDue.toFixed(2)}`;
    if (el.payCashAppBtn) el.payCashAppBtn.textContent = `Pay ${label} with Cash App`;
    if (el.payVenmoBtn) el.payVenmoBtn.textContent = `Pay ${label} with Venmo`;
    setPayButtonsEnabled(true);
  } else {
    // If there is no amount due, pay buttons can use the current cart total (if any)
    const payTotal = Number(cart.length ? total : 0);
    if (payTotal > 0) {
      const label = `$${payTotal.toFixed(2)}`;
      if (el.payCashAppBtn) el.payCashAppBtn.textContent = `Pay ${label} with Cash App`;
      if (el.payVenmoBtn) el.payVenmoBtn.textContent = `Pay ${label} with Venmo`;
      setPayButtonsEnabled(true);
    } else {
      if (el.payCashAppBtn) el.payCashAppBtn.textContent = `Pay with Cash App`;
      if (el.payVenmoBtn) el.payVenmoBtn.textContent = `Pay with Venmo`;
      setPayButtonsEnabled(false);
    }
  }

    function setCartOpen(isOpen) {
      if (!el.cartPanel || !el.cartOverlay) return;

      if (isOpen) {
        el.cartPanel.classList.add("open");
        el.cartOverlay.classList.add("active");
        el.cartPanel.setAttribute("aria-hidden", "false");
        el.cartOverlay.setAttribute("aria-hidden", "false");
      } else {
        el.cartPanel.classList.remove("open");
        el.cartOverlay.classList.remove("active");
        el.cartPanel.setAttribute("aria-hidden", "true");
        el.cartOverlay.setAttribute("aria-hidden", "true");
      }
    }

    function saveCartToStorage() {
      try {
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
      } catch (e) {
        console.warn("Could not save cart:", e);
      }
    }

    function loadCartFromStorage() {
      try {
        const raw = localStorage.getItem(CART_STORAGE_KEY);
        if (!raw) {
          cart = [];
          renderCart();
          return;
        }
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          cart = parsed.map((item) => ({
            sku: item.sku,
            title: item.title,
            price: Number(item.price || 0),
            image: item.image,
            quantity: Number(item.quantity || 1),
          }));
        } else {
          cart = [];
        }
      } catch (e) {
        console.warn("Could not load cart from storage:", e);
        cart = [];
      }

      renderCart();
    }

    function handleFulfillmentChange() {
      const shippingSelected = el.fulfillmentShipping?.checked;
      if (el.shippingFields) {
        el.shippingFields.classList.toggle("hidden", !shippingSelected);
      }

      const pickupLabel = el.fulfillmentPickup?.closest(".shipping-option");
      const shippingLabel = el.fulfillmentShipping?.closest(".shipping-option");
      if (pickupLabel) {
        pickupLabel.classList.toggle("active", !!el.fulfillmentPickup?.checked);
      }
      if (shippingLabel) {
        shippingLabel.classList.toggle("active", !!el.fulfillmentShipping?.checked);
      }

      if (!shippingSelected) {
        setShippingAmount(0);
      }

      updateCartSummary();
    }

    function setShippingAmount(amount) {
      shippingAmount = amount || 0;

      if (el.shippingRateButtons) {
        el.shippingRateButtons.forEach((btn) => {
          const btnAmount = Number(btn.dataset.amount || 0);
          btn.classList.toggle("active", btnAmount === shippingAmount);
        });
      }

      updateCartSummary();
    }

function renderPaymentDue() {
  const total = getPayTotal();
  if (!total) return;

  // Enable and label pay buttons with the payment due amount
  setPayButtonsEnabled(true);

  const label = `$${Number(total).toFixed(2)}`;
  if (el.payCashAppBtn) el.payCashAppBtn.textContent = `Pay ${label} with Cash App`;
  if (el.payVenmoBtn) el.payVenmoBtn.textContent = `Pay ${label} with Venmo`;
}
function handleCheckout() {
  if (!cart.length) {
    alert("Your cart is empty.");
    return;
  }

  const name = (el.checkoutName?.value || "").trim();
  const contact = (el.checkoutContact?.value || "").trim();
  const notes = (el.checkoutNotes?.value || "").trim();

  if (!name || !contact) {
    alert("Please enter your name and the best way to reach you.");
    return;
  }

  const fulfillment =
    el.fulfillmentShipping && el.fulfillmentShipping.checked ? "shipping" : "pickup";

  // Build shipping object if needed
  let shipping = null;
  let shippingCost = 0;

  if (fulfillment === "shipping") {
    const address1 = (el.shippingAddress1?.value || "").trim();
    const city = (el.shippingCity?.value || "").trim();
    const state = (el.shippingState?.value || "").trim();
    const zip = (el.shippingZip?.value || "").trim();

    if (!address1 || !city || !state || !zip) {
      alert("Please fill out your full shipping address.");
      return;
    }

    shipping = {
      address1,
      address2: (el.shippingAddress2?.value || "").trim(),
      city,
      state,
      zip,
    };

    shippingCost = Number(shippingAmount || 0);
  }

  // Order ID for matching payments
  lastOrderId = getOrderId_();

  // Snapshot BEFORE we clear anything
  const cartSnapshot = cart.map((item) => ({ ...item }));

  // Totals
  const subtotal = cartSnapshot.reduce((sum, item) => sum + item.price * item.quantity, 0);
  const tax = +(subtotal * TAX_RATE).toFixed(2);
  const grandTotal = subtotal + tax + (fulfillment === "shipping" ? shippingCost : 0);

 setLastSubmittedTotal(grandTotal);   // ‚úÖ call the function
currentCartTotal = grandTotal;
checkoutSubmitted = true;

updateCartSummary();                // refresh UI numbers
setPayButtonsEnabled(true);         // enable pay buttons
updatePayButtonLabels();            // (optional) ok to keep

  // Payload to Apps Script / Sheet
  const orderPayload = {
    orderId: lastOrderId,
    items: cartSnapshot.map((item) => ({ sku: item.sku, quantity: item.quantity })),
    totals: {
      subtotal,
      tax,
      shipping: fulfillment === "shipping" ? shippingCost : 0,
      grand_total: grandTotal,
    },
    buyer: { name, contact },
    fulfillment,
    shipping,
    notes,
  };

  // Send to sheet (non-blocking)
  sendOrderToSheet(orderPayload);

  // Refresh products after Sheets stock updates
  setTimeout(() => loadProducts(), 1500);

  // Toast message
  if (el.checkoutMessage) {
    el.checkoutMessage.textContent =
      `Cart submitted! Total: $${grandTotal.toFixed(2)} ‚Ä¢ Order ${lastOrderId}. ` +
      `Pay via Cash App $Kern4460 or Venmo @Jason_Kern4460.`;
    el.checkoutMessage.classList.remove("hidden");
    el.checkoutMessage.classList.add("show");
    setTimeout(() => el.checkoutMessage.classList.remove("show"), 8000);
  }

  // Clear cart AFTER submit
  clearCartAfterCheckout();
  renderPaymentDue();
  updateCartSummary();
  // Re-render
  applyFilters();
  renderCart();
}

function sendOrderToSheet(orderPayload) {
  if (!APPS_SCRIPT_URL) return;

  try {
    const encoded = encodeURIComponent(JSON.stringify(orderPayload));
    const url = APPS_SCRIPT_URL + "?payload=" + encoded + "&t=" + Date.now();

    // Keep a reference so Safari doesn‚Äôt garbage-collect early
    window.__flashbidzBeacon = new Image();
    window.__flashbidzBeacon.src = url;
  } catch (e) {
    console.error("sendOrderToSheet failed:", e);
  }
}

    function clearCartAfterCheckout() {
      cart = [];
      saveCartToStorage();
      renderCart();
    }

    function setCurrentYear() {
      const yearEl = document.getElementById("year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();
    }

    function playAddToCartSound() {
      if (el.addToCartSound && typeof el.addToCartSound.play === "function") {
        el.addToCartSound.currentTime = 0;
        el.addToCartSound.play().catch(() => {});
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function openProductModal(product) {
      if (!el.modal) return;

      currentModalImages =
        Array.isArray(product.images) && product.images.length
          ? product.images
          : [product.image || "img/placeholder.png"];
      currentModalImageIndex = 0;

      el.modalMainImage.src = currentModalImages[0];
      el.modalMainImage.alt = product.title || "";
      el.modalTitle.textContent = product.title || "";
      el.modalSku.textContent = product.sku ? "SKU: " + product.sku : "";
      el.modalPrice.textContent =
        "$" + Number(product.price || 0).toFixed(2);
      el.modalDescription.textContent =
        product.description || "No additional description provided.";

      el.modalThumbs.innerHTML = "";
      currentModalImages.forEach((src, index) => {
        const thumb = document.createElement("button");
        thumb.type = "button";
        thumb.className = "modal-thumb";
        thumb.innerHTML = `<img src="${src}" alt="">`;
        thumb.addEventListener("click", () => {
          currentModalImageIndex = index;
          el.modalMainImage.src = src;
        });
        el.modalThumbs.appendChild(thumb);
      });

      el.modalMainImage.onclick = () => {
        if (!currentModalImages.length) return;
        currentModalImageIndex =
          (currentModalImageIndex + 1) % currentModalImages.length;
        el.modalMainImage.src = currentModalImages[currentModalImageIndex];
      };

      el.modal.dataset.sku = product.sku || "";
      el.modal.classList.add("open");
      el.modal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      if (!el.modal) return;
      el.modal.classList.remove("open");
      el.modal.setAttribute("aria-hidden", "true");
    }

    function initTheme() {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      const html = document.documentElement;
      if (stored === "dark" || stored === "light") {
        html.setAttribute("data-theme", stored);
      }
      updateThemeLabel();
    }

    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute("data-theme") || "light";
      const next = current === "light" ? "dark" : "light";
      html.setAttribute("data-theme", next);
      localStorage.setItem(THEME_STORAGE_KEY, next);
      updateThemeLabel();
    }
function handleCashAppPay() {
  const amountDue = Number(lastSubmittedTotal || 0);
  const total = amountDue > 0 ? amountDue : Number(currentCartTotal || 0);

  if (!total) {
    alert("Submit your cart first (or add at least one item).");
    return;
  }

  const amount = total.toFixed(2);
  const note = encodeURIComponent(lastOrderId ? `FlashBidz ${lastOrderId}` : "FlashBidz Store order");
  const url = `https://cash.app/$Kern4460/${amount}?note=${note}`;
  window.open(url, "_blank");
  clearAmountDue();
}

function handleVenmoPay() {
  const amountDue = Number(lastSubmittedTotal || 0);
  const total = amountDue > 0 ? amountDue : Number(currentCartTotal || 0);

  if (!total) {
    alert("Submit your cart first (or add at least one item).");
    return;
  }

  const amount = total.toFixed(2);
  const note = encodeURIComponent(lastOrderId ? `FlashBidz ${lastOrderId}` : "FlashBidz Store order");
  const url = `https://venmo.com/?txn=pay&audience=private&recipients=Jason_Kern4460&amount=${amount}&note=${note}`;
  window.open(url, "_blank");
  clearAmountDue();
}
    
    function updateThemeLabel() {
      const theme = document.documentElement.getAttribute("data-theme") || "light";
      if (!el.themeLabel) return;
      if (theme === "dark") {
        el.themeLabel.textContent = "Dark";
        if (el.themeToggle?.firstElementChild) {
          el.themeToggle.firstElementChild.textContent = "üåô";
        }
      } else {
        el.themeLabel.textContent = "Light";
        if (el.themeToggle?.firstElementChild) {
          el.themeToggle.firstElementChild.textContent = "‚òÄÔ∏è";
        }
      }
    }
  </script>
</body>
</html>
