<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlashBidz Store — Local Deals • Mattawan, MI</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <meta name="description" content="FlashBidz — fixed-price local deals with easy pickup in Mattawan, MI." />
</head>
<body>
  <header class="site-header" id="top">
    <a class="brand" href="#top">
      <img src="img/flashbidz_logo.svg" alt="FlashBidz" class="logoimg" />
      <div class="name">
        <h1>FlashBidz Store</h1>
        <p class="tagline">Neighbors Helping Neighbors • Mattawan, MI</p>
      </div>
    </a>
    <nav class="top-cta">
      <a class="btn btn-primary" href="#shop">Shop</a>
      <a class="btn" href="#pickup">Pickup Info</a>
      <a class="btn" href="https://www.facebook.com/flashbidz.mattawan" target="_blank" rel="noopener">Message on Facebook</a>
    </nav>
  </header>

  <!-- Cart bar -->
  <section class="cart-bar" aria-label="Shopping cart">
    <button id="cart-toggle" class="btn cart-btn" type="button">
      Cart (<span id="cart-count">0</span>) • <span id="cart-total">$0.00</span>
    </button>
  </section>

  <!-- Slide-out cart panel -->
  <div id="cart-panel" class="cart-panel hidden" aria-hidden="true">
    <div class="cart-panel-inner">
      <h3>Your Cart</h3>
      <div id="cart-items" class="cart-items"></div>

      <div class="cart-summary">
        <div>Subtotal: <strong id="cart-subtotal">$0.00</strong></div>
        <div>MI Tax (6%): <strong id="cart-tax">$0.00</strong></div>
        <div>Total: <strong id="cart-grand-total">$0.00</strong></div>
      </div>

      <p class="cart-note-label">Payment note we’ll attach (you may see it in Venmo/Cash App):</p>
      <pre id="cart-note" class="cart-note"></pre>

      <div class="actions two co-actions">
        <button id="cart-venmo" class="btn pay venmo" type="button">Pay with Venmo</button>
        <button id="cart-cash" class="btn pay cashapp" type="button">Pay with Cash App</button>
      </div>

      <p class="cart-help">
        After you pay, please send us a quick Facebook message with a screenshot so we can match your payment to your order.
      </p>
    </div>
  </div>

  <section class="hero">
    <h2>Local Deals • Easy Pickup • No Bidding</h2>
    <p>Prices shown are <strong>before tax</strong>. Michigan sales tax is added at checkout.</p>
    <div class="hero-cta">
      <input id="q" class="search" type="search" placeholder="Search items… (e.g., bassinet, tools, Barbie)" aria-label="Search products" />
      <a class="btn btn-primary hero-browse" href="#shop" onclick="document.getElementById('q').focus()">Browse All</a>
    </div>
  </section>

  <main id="shop" class="container">
    <div class="toolbar">
      <div class="toolbar-left">
        <label class="toolbar-label">
          Category:
          <select id="cat" class="select">
            <option value="">All categories</option>
          </select>
        </label>
      </div>
      <div class="toolbar-right">
        <label class="toolbar-label">
          Sort:
          <select id="sort" class="select">
            <option value="new">Newest</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
          </select>
        </label>
        <span id="count" class="count"></span>
      </div>
    </div>

    <div id="product-grid" class="grid" aria-live="polite"></div>
  </main>

  <section id="pickup" class="pickup container">
    <h3>Pickup, Payment & Policies</h3>
    <ul>
      <li><strong>Pickup:</strong> Mattawan, MI (exact address provided after purchase). Please pick up within <strong>7 days</strong>.</li>
      <li><strong>Storage:</strong> After 7 days, <strong>$2 per item per day</strong>. After 14 days, items are <strong>abandoned</strong>.</li>
      <li><strong>Payment:</strong> Pay with <strong>Venmo or Cash App</strong>. MI <strong>6% sales tax</strong> is included in the total.</li>
      <li><strong>Condition:</strong> Items sold <em>AS-IS, WHERE-IS</em>. <strong>All sales final.</strong></li>
      <li><strong>Questions?</strong> Message us on Facebook or email <a href="mailto:support@flashbidz.net">support@flashbidz.net</a>.</li>
    </ul>
  </section>

  <footer class="site-footer">
    <p>© <span id="year"></span> FlashBidz of Mattawan • All sales final • AS-IS, WHERE-IS</p>
  </footer>

  <!-- Product card template -->
  <template id="product-card-tpl">
    <article class="card">
      <div class="img-wrap">
        <img src="" alt="" loading="lazy" />
        <span class="badge"></span>
      </div>
      <div class="card-body">
        <h4 class="title"></h4>
        <p class="desc"></p>

        <div class="meta">
          <span class="price"></span>
          <span class="stock"></span>
        </div>

        <div class="totals">
          <div>Subtotal: <strong class="subtotal"></strong></div>
          <div>MI Sales Tax (<span class="tax-rate"></span>%): <strong class="tax"></strong></div>
          <div>Total: <strong class="total"></strong></div>
        </div>

        <div class="actions">
          <button class="btn btn-primary add-to-cart" type="button">
            Add to Cart
          </button>
        </div>
      </div>
    </article>
  </template>

  <!-- Image gallery modal -->
  <div id="image-modal" class="image-modal hidden">
    <div class="image-modal-backdrop" onclick="closeImageModal()"></div>
    <div class="image-modal-content">
      <button class="image-modal-close" type="button" onclick="closeImageModal()">×</button>
      <img id="image-modal-main" src="" alt="Product image" />
      <div id="image-modal-thumbs" class="image-modal-thumbs"></div>
    </div>
  </div>

  <script>
    // ===== SETTINGS =====
    const CASH_APP_TAG = "FlashBidz"; // Cash App $tag (without the $)
    const VENMO_USER   = "FlashBidz"; // Venmo user (venmo.com/u/FlashBidz)
    const MI_TAX_RATE  = 0.06;        // 6% Michigan sales tax

    // ===== BASIC ELEMENTS =====
    const YEAR_EL = document.getElementById("year");
    if (YEAR_EL) YEAR_EL.textContent = new Date().getFullYear();

    const grid    = document.getElementById("product-grid");
    const tpl     = document.getElementById("product-card-tpl");
    const q       = document.getElementById("q");
    const cat     = document.getElementById("cat");
    const sortSel = document.getElementById("sort");
    const countEl = document.getElementById("count");

    // Cart elements
    const cartToggle  = document.getElementById("cart-toggle");
    const cartPanel   = document.getElementById("cart-panel");
    const cartItemsEl = document.getElementById("cart-items");
    const cartCountEl = document.getElementById("cart-count");
    const cartTotalEl = document.getElementById("cart-total");
    const cartSubEl   = document.getElementById("cart-subtotal");
    const cartTaxEl   = document.getElementById("cart-tax");
    const cartGrandEl = document.getElementById("cart-grand-total");
    const cartNoteEl  = document.getElementById("cart-note");
    const cartVenmo   = document.getElementById("cart-venmo");
    const cartCash    = document.getElementById("cart-cash");

    let PRODUCTS = [];
    let CART = [];

    function fmt(n) {
      return "$" + (Number(n) || 0).toFixed(2);
    }

    // ===== PAYMENT LINK HELPERS =====
    function buildVenmoLink(amount, note) {
      if (!VENMO_USER) return "";
      return `https://venmo.com/u/${VENMO_USER}?txn=pay&amount=${(amount || 0).toFixed(2)}&note=${encodeURIComponent(note)}`;
    }

    function buildCashAppLink(amount, note) {
      if (!CASH_APP_TAG) return "";
      return `https://cash.app/$${CASH_APP_TAG}?amount=${(amount || 0).toFixed(2)}&note=${encodeURIComponent(note)}`;
    }

    // ===== LOAD PRODUCTS =====
    async function loadProducts() {
      const res = await fetch("products.json?" + Date.now());
      const data = await res.json();
      PRODUCTS = data.products || [];

      // Normalize images: ensure every product has images[] and image
      PRODUCTS.forEach(p => {
        if (!Array.isArray(p.images) || !p.images.length) {
          if (p.image) {
            p.images = [p.image];
          } else {
            p.images = ["img/placeholder.png"];
          }
        }
        if (!p.image) {
          p.image = p.images[0];
        }
      });

      // Build category dropdown
      const cats = Array.from(
        new Set(PRODUCTS.flatMap(p => p.categories || []))
      ).filter(Boolean).sort();

      cats.forEach(c => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        cat.appendChild(o);
      });

      render();
    }

    // ===== RENDER GRID =====
    function render() {
      const query       = (q?.value || "").toLowerCase().trim();
      const selectedCat = cat?.value || "";
      const sort        = sortSel?.value || "new";

      let items = PRODUCTS.filter(p => p.active !== false);

      if (selectedCat) {
        items = items.filter(p => (p.categories || []).includes(selectedCat));
      }

      if (query) {
        items = items.filter(p =>
          ((p.title || "") + " " + (p.description || ""))
            .toLowerCase()
            .includes(query)
        );
      }

      if (sort === "price-asc") {
        items.sort((a, b) => (a.price || 0) - (b.price || 0));
      } else if (sort === "price-desc") {
        items.sort((a, b) => (b.price || 0) - (a.price || 0));
      } else {
        items.sort(
          (a, b) =>
            new Date(b.added_at || 0).getTime() -
            new Date(a.added_at || 0).getTime()
        );
      }

      grid.innerHTML = "";
      items.forEach(p => {
        const node       = tpl.content.cloneNode(true);
        const img        = node.querySelector("img");
        const title      = node.querySelector(".title");
        const desc       = node.querySelector(".desc");
        const priceEl    = node.querySelector(".price");
        const stockEl    = node.querySelector(".stock");
        const badgeEl    = node.querySelector(".badge");
        const subEl      = node.querySelector(".subtotal");
        const taxEl      = node.querySelector(".tax");
        const totalEl    = node.querySelector(".total");
        const taxRateEl  = node.querySelector(".tax-rate");
        const addBtn     = node.querySelector(".add-to-cart");

        // Image + gallery
        img.src = p.image || "img/placeholder.png";
        img.alt = p.title || "";
        img.style.cursor = "pointer";
        img.addEventListener("click", () => openImageModal(p));

        // Text
        title.textContent   = p.title || "";
        desc.textContent    = p.description || "";
        priceEl.textContent = p.price ? fmt(p.price) : "";
        stockEl.textContent = (p.stock && p.stock > 0) ? "In Stock" : "Sold Out";

        if (p.badge) {
          badgeEl.textContent = p.badge;
        } else {
          badgeEl.remove();
        }

        // Totals
        const subtotal = Number(p.price || 0);
        const tax      = +(subtotal * MI_TAX_RATE).toFixed(2);
        const total    = +(subtotal + tax).toFixed(2);

        taxRateEl.textContent = (MI_TAX_RATE * 100).toFixed(0);
        subEl.textContent     = fmt(subtotal);
        taxEl.textContent     = fmt(tax);
        totalEl.textContent   = fmt(total);

        // Add to cart
        if (addBtn) {
          if (p.stock && p.stock > 0) {
            addBtn.disabled = false;
            addBtn.textContent = "Add to Cart";
            addBtn.addEventListener("click", () => addToCart(p));
          } else {
            addBtn.disabled = true;
            addBtn.textContent = "Sold Out";
          }
        }

        grid.appendChild(node);
      });

      if (countEl) {
        countEl.textContent =
          items.length + " item" + (items.length === 1 ? "" : "s");
      }
    }

    // ===== CART LOGIC =====
    function loadCart() {
      try {
        const raw = localStorage.getItem("fbz_cart");
        CART = raw ? JSON.parse(raw) : [];
      } catch (e) {
        CART = [];
      }
    }

    function saveCart() {
      localStorage.setItem("fbz_cart", JSON.stringify(CART));
    }

    function findCartIndex(sku) {
      return CART.findIndex(item => item.sku === sku);
    }

    function addToCart(product) {
      if (!product || !product.sku) return;
      const idx = findCartIndex(product.sku);
      if (idx >= 0) {
        CART[idx].qty += 1;
      } else {
        CART.push({
          sku: product.sku,
          title: product.title,
          price: Number(product.price || 0),
          qty: 1
        });
      }
      saveCart();
      updateCartUI(true);
    }

    function changeQty(sku, delta) {
      const idx = findCartIndex(sku);
      if (idx < 0) return;
      CART[idx].qty += delta;
      if (CART[idx].qty <= 0) {
        CART.splice(idx, 1);
      }
      saveCart();
      updateCartUI();
    }

    function removeFromCart(sku) {
      CART = CART.filter(item => item.sku !== sku);
      saveCart();
      updateCartUI();
    }

    function getCartTotals() {
      let subtotal = 0;
      CART.forEach(item => {
        subtotal += item.price * item.qty;
      });
      const tax = +(subtotal * MI_TAX_RATE).toFixed(2);
      const total = +(subtotal + tax).toFixed(2);
      const count = CART.reduce((acc, item) => acc + item.qty, 0);
      return { subtotal, tax, total, count };
    }

    function buildCartNote() {
      if (!CART.length) return "";
      const parts = CART.map(item => `${item.sku}x${item.qty}`);
      let note = "FBZ Cart: " + parts.join(", ");
      if (note.length > 90) {
        note = note.slice(0, 87) + "...";
      }
      return note;
    }

    function updateCartUI(openPanelIfHasItems = false) {
      const { subtotal, tax, total, count } = getCartTotals();

      if (cartCountEl) cartCountEl.textContent = count;
      if (cartTotalEl) cartTotalEl.textContent = fmt(total);
      if (cartSubEl)  cartSubEl.textContent  = fmt(subtotal);
      if (cartTaxEl)  cartTaxEl.textContent  = fmt(tax);
      if (cartGrandEl)cartGrandEl.textContent= fmt(total);

      const note = buildCartNote();
      if (cartNoteEl) cartNoteEl.textContent = note || "(Cart is empty)";

      cartItemsEl.innerHTML = "";

      if (!CART.length) {
        const empty = document.createElement("p");
        empty.textContent = "Your cart is empty.";
        empty.className = "muted";
        cartItemsEl.appendChild(empty);
      } else {
        CART.forEach(item => {
          const row = document.createElement("div");
          row.className = "cart-item";

          const title = document.createElement("div");
          title.className = "cart-item-title";
          title.textContent = item.title;

          const controls = document.createElement("div");
          controls.className = "cart-item-controls";

          const minus = document.createElement("button");
          minus.type = "button";
          minus.className = "cart-qty-btn";
          minus.textContent = "−";
          minus.addEventListener("click", () => changeQty(item.sku, -1));

          const qty = document.createElement("span");
          qty.className = "cart-qty";
          qty.textContent = item.qty;

          const plus = document.createElement("button");
          plus.type = "button";
          plus.className = "cart-qty-btn";
          plus.textContent = "+";
          plus.addEventListener("click", () => changeQty(item.sku, +1));

          controls.append(minus, qty, plus);

          const right = document.createElement("div");
          right.style.textAlign = "right";

          const line = document.createElement("div");
          line.textContent = fmt(item.price * item.qty);

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "cart-remove";
          remove.textContent = "Remove";
          remove.addEventListener("click", () => removeFromCart(item.sku));

          right.append(line, remove);

          row.append(title, controls, right);
          cartItemsEl.appendChild(row);
        });
      }

      if (openPanelIfHasItems && CART.length) {
        openCartPanel();
      }
    }

    function openCartPanel() {
      if (!cartPanel) return;
      cartPanel.classList.remove("hidden");
      cartPanel.setAttribute("aria-hidden", "false");
    }

    function closeCartPanel() {
      if (!cartPanel) return;
      cartPanel.classList.add("hidden");
      cartPanel.setAttribute("aria-hidden", "true");
    }

    function checkoutWith(method) {
      if (!CART.length) {
        alert("Your cart is empty.");
        return;
      }
      const { total } = getCartTotals();
      const note = buildCartNote();
      let url = "";

      if (method === "venmo") {
        url = buildVenmoLink(total, note);
      } else if (method === "cash") {
        url = buildCashAppLink(total, note);
      }

      if (!url) {
        alert("Payment link could not be generated.");
        return;
      }

      window.open(url, "_blank");
    }

    // ===== MINI GALLERY MODAL =====
    function openImageModal(product) {
      const modal   = document.getElementById("image-modal");
      const mainImg = document.getElementById("image-modal-main");
      const thumbs  = document.getElementById("image-modal-thumbs");

      const imgs = (product.images && product.images.length)
        ? product.images
        : [product.image || "img/placeholder.png"];

      mainImg.src = imgs[0];
      mainImg.alt = product.title || "";

      thumbs.innerHTML = "";
      imgs.forEach((src, idx) => {
        const t = document.createElement("img");
        t.src = src;
        t.alt = product.title || "";
        if (idx === 0) t.classList.add("active-thumb");
        t.addEventListener("click", () => {
          mainImg.src = src;
          thumbs.querySelectorAll("img").forEach(el => el.classList.remove("active-thumb"));
          t.classList.add("active-thumb");
        });
        thumbs.appendChild(t);
      });

      modal.classList.remove("hidden");
    }

    function closeImageModal() {
      const modal = document.getElementById("image-modal");
      modal.classList.add("hidden");
    }

    window.closeImageModal = closeImageModal;

    // ===== EVENTS =====
    q?.addEventListener("input", render);
    cat?.addEventListener("change", render);
    sortSel?.addEventListener("change", render);

    if (cartToggle) {
      cartToggle.addEventListener("click", () => {
        const isHidden = cartPanel.classList.contains("hidden");
        if (isHidden) openCartPanel();
        else closeCartPanel();
      });
    }

    if (cartPanel) {
      cartPanel.addEventListener("click", (e) => {
        if (e.target === cartPanel) closeCartPanel();
      });
    }

    if (cartVenmo) {
      cartVenmo.addEventListener("click", () => checkoutWith("venmo"));
    }

    if (cartCash) {
      cartCash.addEventListener("click", () => checkoutWith("cash"));
    }

    // ===== INIT =====
    loadCart();
    updateCartUI();
    loadProducts();
  </script>
</body>
</html>
