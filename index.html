<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlashBidz Store — Local Deals • Mattawan, MI</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <meta name="description" content="FlashBidz — fixed-price local deals with easy pickup in Mattawan, MI." />
</head>
<body>
  <header class="site-header" id="top">
    <a class="brand" href="#top">
      <img src="img/flashbidz_logo.svg" alt="FlashBidz" class="logoimg" />
      <div class="name">
        <h1>FlashBidz Store</h1>
        <p class="tagline">Neighbors Helping Neighbors • Mattawan, MI</p>
      </div>
    </a>
    <nav class="top-cta">
      <a class="btn btn-primary" href="#shop">Shop</a>
      <a class="btn" href="#pickup">Pickup Info</a>
      <a class="btn" href="https://www.facebook.com/flashbidz.mattawan" target="_blank" rel="noopener">Message on Facebook</a>
    </nav>
  </header>

  <!-- Cart bar -->
  <section class="cart-bar">
    <button id="cart-toggle" class="cart-toggle">
      Cart (<span id="cart-count">0</span>) • <span id="cart-total">$0.00</span>
    </button>
  </section>

  <!-- Slide-out cart panel -->
  <aside id="cart-panel" class="cart-panel">
    <div class="cart-panel-inner">
      <h3>Your Cart</h3>

      <ul id="cart-items" class="cart-items">
        <!-- Cart items injected by JS -->
      </ul>

      <div class="cart-summary">
        <div>
          <span>Subtotal</span>
          <strong id="cart-subtotal">$0.00</strong>
        </div>
        <div>
          <span>MI Tax (6%)</span>
          <strong id="cart-tax">$0.00</strong>
        </div>
        <div class="cart-grand">
          <span>Total</span>
          <strong id="cart-grandtotal">$0.00</strong>
        </div>
      </div>

      <button id="checkout-btn" class="btn btn-primary cart-checkout-btn">
        Pay securely with card
      </button>
      <p class="cart-note">
        You’ll be taken to Stripe’s secure checkout. We’ll message you with pickup info after payment.
      </p>
    </div>
  </aside>

  <!-- Checkout status bar -->
  <div id="checkout-message" class="checkout-message hidden"></div>

  <section class="hero">
    <h2>Local Deals • Easy Pickup • No Bidding</h2>
    <p>Prices shown are <strong>before tax</strong>. Michigan sales tax is added at checkout.</p>
    <div class="hero-cta">
      <input id="q" class="search" type="search" placeholder="Search items… (e.g., bassinet, tools, Barbie)" aria-label="Search products" />
      <a class="btn btn-primary hero-browse" href="#shop" onclick="document.getElementById('q').focus()">Browse All</a>
    </div>
  </section>

  <main id="shop" class="container">
    <div class="toolbar">
      <div class="toolbar-left">
        <label class="toolbar-label">
          Category:
          <select id="cat" class="select">
            <option value="">All categories</option>
          </select>
        </label>
      </div>
      <div class="toolbar-right">
        <label class="toolbar-label">
          Sort:
          <select id="sort" class="select">
            <option value="new">Newest</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
          </select>
        </label>
        <span id="count" class="count"></span>
      </div>
    </div>

    <div id="product-grid" class="grid" aria-live="polite"></div>
  </main>

  <section id="pickup" class="pickup container">
    <h3>Pickup, Payment & Policies</h3>
    <ul>
      <li><strong>Pickup:</strong> Mattawan, MI (exact address provided after purchase). Please pick up within <strong>7 days</strong>.</li>
      <li><strong>Storage:</strong> After 7 days, <strong>$2 per item per day</strong>. After 14 days, items are <strong>abandoned</strong>.</li>
      <li><strong>Payment:</strong> Pay by card via our secure checkout. MI <strong>6% sales tax</strong> is included in the total.</li>
      <li><strong>Condition:</strong> Items sold <em>AS-IS, WHERE-IS</em>. <strong>All sales final.</strong></li>
      <li><strong>Questions?</strong> Message us on Facebook or email <a href="mailto:support@flashbidz.net">support@flashbidz.net</a>.</li>
    </ul>
  </section>

  <footer class="site-footer">
    <p>© <span id="year"></span> FlashBidz of Mattawan • All sales final • AS-IS, WHERE-IS</p>
  </footer>

  <!-- Product card template -->
  <template id="product-card-tpl">
    <article class="card">
      <div class="img-wrap">
        <img src="" alt="" loading="lazy" />
        <span class="badge"></span>
      </div>
      <div class="card-body">
        <h4 class="title"></h4>
        <p class="desc"></p>

        <div class="meta">
          <span class="price"></span>
          <span class="stock"></span>
        </div>

        <div class="totals">
          <div>Subtotal: <strong class="subtotal"></strong></div>
          <div>MI Sales Tax (<span class="tax-rate"></span>%): <strong class="tax"></strong></div>
          <div>Total: <strong class="total"></strong></div>
        </div>

        <div class="actions">
          <button class="btn btn-primary add-to-cart" type="button">
            Add to Cart
          </button>
        </div>
      </div>
    </article>
  </template>

  <!-- Image gallery modal (upgraded) -->
  <div id="image-modal" class="image-modal hidden" aria-modal="true" role="dialog">
    <div class="image-modal-backdrop"></div>
    <div class="image-modal-content">
      <button class="image-modal-close" type="button" aria-label="Close">&times;</button>

      <div class="image-modal-main-wrap">
        <button class="image-modal-arrow left" type="button" aria-label="Previous image">‹</button>
        <img id="image-modal-main" src="" alt="Product image" />
        <button class="image-modal-arrow right" type="button" aria-label="Next image">›</button>
      </div>

      <div class="image-modal-meta">
        <span id="image-modal-caption"></span>
        <span id="image-modal-count"></span>
      </div>

      <div id="image-modal-thumbs" class="image-modal-thumbs"></div>
    </div>
  </div>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    // =========================
    //  SETTINGS
    // =========================
    const STRIPE_PUBLISHABLE_KEY = "pk_live_51Sa4lgCY2ro7M4zrxnzepY4UR27lu8NuSG1Ig2d29Zg2Mb3bHV58nVMPacWHGbhyOV5qBirT8JTneZODr7UvkuDJ00nwHIISsM";
    const STRIPE_PRICE_ID = "price_REPLACE_ME"; // <-- put your real Price ID here
    const MI_TAX_RATE = 0.06; // 6%

    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    let PRODUCTS = [];
    const CART = {}; // { sku: { product, qty } }

    function money(n) {
      return "$" + (Number(n) || 0).toFixed(2);
    }

    function getMainImage(p) {
      if (p.images && p.images.length) return p.images[0];
      if (p.image) return p.image;
      return "img/placeholder.png";
    }

    function getAllImages(p) {
      if (p.images && p.images.length) return p.images;
      if (p.image) return [p.image];
      return ["img/placeholder.png"];
    }

    // =========================
    //  DOM ELEMENTS
    // =========================
    const grid      = document.getElementById("product-grid");
    const tpl       = document.getElementById("product-card-tpl");
    const qInput    = document.getElementById("q");
    const catSelect = document.getElementById("cat");
    const sortSelect= document.getElementById("sort");
    const countEl   = document.getElementById("count");

    const cartCountEl    = document.getElementById("cart-count");
    const cartTotalEl    = document.getElementById("cart-total");
    const cartListEl     = document.getElementById("cart-items");
    const cartPanel      = document.getElementById("cart-panel");
    const cartToggle     = document.getElementById("cart-toggle");
    const cartSubEl      = document.getElementById("cart-subtotal");
    const cartTaxEl      = document.getElementById("cart-tax");
    const cartGrandEl    = document.getElementById("cart-grandtotal");
    const checkoutBtn    = document.getElementById("checkout-btn");
    const checkoutMsgBar = document.getElementById("checkout-message");

    const yearEl = document.getElementById("year");
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    // =========================
    //  IMAGE MODAL ELEMENTS
    // =========================
    const imageModal          = document.getElementById("image-modal");
    const imageModalBackdrop  = document.querySelector(".image-modal-backdrop");
    const imageModalCloseBtn  = document.querySelector(".image-modal-close");
    const imageModalMain      = document.getElementById("image-modal-main");
    const imageModalThumbs    = document.getElementById("image-modal-thumbs");
    const imageModalCount     = document.getElementById("image-modal-count");
    const imageModalCaption   = document.getElementById("image-modal-caption");
    const imageModalArrowLeft = document.querySelector(".image-modal-arrow.left");
    const imageModalArrowRight= document.querySelector(".image-modal-arrow.right");

    let modalOpen   = false;
    let modalProduct= null;
    let modalImages = [];
    let modalIndex  = 0;
    let touchStartX = 0;

    // =========================
    //  LOAD PRODUCTS
    // =========================
    async function loadProducts() {
      try {
        const res = await fetch("products.json?" + Date.now());
        if (!res.ok) throw new Error("products.json not found");
        const data = await res.json();
        PRODUCTS = data.products || [];
      } catch (err) {
        console.error("Error loading products:", err);
        if (grid) {
          grid.innerHTML = "<p style='color:#ccc'>Could not load products.json</p>";
        }
        return;
      }

      // Build category dropdown
      if (catSelect) {
        const cats = Array.from(
          new Set(PRODUCTS.flatMap(p => p.categories || []))
        ).sort();
        cats.forEach(c => {
          if (!c) return;
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          catSelect.appendChild(opt);
        });
      }

      renderGrid();
    }

    function renderGrid() {
      if (!grid || !tpl) return;
      const query       = (qInput && qInput.value || "").toLowerCase().trim();
      const selectedCat = catSelect ? catSelect.value : "";
      const sort        = sortSelect ? sortSelect.value : "new";

      let items = PRODUCTS.filter(p => p.active !== false);

      if (selectedCat) {
        items = items.filter(p => (p.categories || []).includes(selectedCat));
      }
      if (query) {
        items = items.filter(p =>
          (p.title + " " + (p.description || "")).toLowerCase().includes(query)
        );
      }

      if (sort === "price-asc") {
        items.sort((a,b) => (a.price || 0) - (b.price || 0));
      } else if (sort === "price-desc") {
        items.sort((a,b) => (b.price || 0) - (a.price || 0));
      } else {
        items.sort((a,b) => new Date(b.added_at || 0) - new Date(a.added_at || 0));
      }

      grid.innerHTML = "";
      items.forEach(p => {
        const node = tpl.content.cloneNode(true);

        const card      = node.querySelector(".card");
        const imgWrap   = node.querySelector(".img-wrap");
        const img       = node.querySelector("img");
        const titleEl   = node.querySelector(".title");
        const descEl    = node.querySelector(".desc");
        const priceEl   = node.querySelector(".price");
        const stockEl   = node.querySelector(".stock");
        const badgeEl   = node.querySelector(".badge");
        const subEl     = node.querySelector(".subtotal");
        const taxEl     = node.querySelector(".tax");
        const totalEl   = node.querySelector(".total");
        const taxRateEl = node.querySelector(".tax-rate");
        const actions   = node.querySelector(".actions");

        // Add to Cart button
        if (actions) {
          actions.innerHTML = "";
          const addBtn = document.createElement("button");
          addBtn.type = "button";
          addBtn.className = "btn btn-primary btn-cart";
          addBtn.textContent = "Add to Cart";
          addBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            addToCart(p);
          });
          actions.appendChild(addBtn);
        }

        const imgs = getAllImages(p);

        if (img) {
          img.src = imgs[0];
          img.alt = p.title || "Item";
        }
        if (titleEl) titleEl.textContent = p.title;
        if (descEl)  descEl.textContent  = p.description || "";
        if (priceEl) priceEl.textContent = p.price ? money(p.price) : "";
        if (stockEl) stockEl.textContent = p.stock && p.stock > 0 ? "In Stock" : "Sold Out";

        if (badgeEl) {
          if (p.badge) badgeEl.textContent = p.badge;
          else badgeEl.remove();
        }

        const subtotal = Number(p.price || 0);
        const tax      = +(subtotal * MI_TAX_RATE).toFixed(2);
        const total    = +(subtotal + tax).toFixed(2);

        if (taxRateEl) taxRateEl.textContent = (MI_TAX_RATE * 100).toFixed(0);
        if (subEl)     subEl.textContent     = money(subtotal);
        if (taxEl)     taxEl.textContent     = money(tax);
        if (totalEl)   totalEl.textContent   = money(total);

        // Clicking the photo opens the gallery
        if (imgWrap) {
          imgWrap.addEventListener("click", (e) => {
            e.stopPropagation();
            openImageModal(p, 0);
          });
        }

        grid.appendChild(node);
      });

      if (countEl) {
        countEl.textContent = items.length + " item" + (items.length === 1 ? "" : "s");
      }
    }

    if (qInput)    qInput.addEventListener("input", renderGrid);
    if (catSelect) catSelect.addEventListener("change", renderGrid);
    if (sortSelect)sortSelect.addEventListener("change", renderGrid);

    // =========================
    //  CART
    // =========================
    function getCartItems() {
      return Object.values(CART);
    }

    function cartTotals() {
      const items = getCartItems();
      let sub = 0;
      items.forEach(i => {
        sub += (Number(i.product.price) || 0) * i.qty;
      });
      const tax = +(sub * MI_TAX_RATE).toFixed(2);
      const total = +(sub + tax).toFixed(2);
      return { sub, tax, total, items };
    }

    function addToCart(product) {
      if (!product.sku) return;
      if (!CART[product.sku]) {
        CART[product.sku] = { product, qty: 0 };
      }
      CART[product.sku].qty += 1;
      updateCartUI();
    }

    function changeQty(sku, delta) {
      const entry = CART[sku];
      if (!entry) return;
      entry.qty += delta;
      if (entry.qty <= 0) delete CART[sku];
      updateCartUI();
    }

    function updateCartUI() {
      const { sub, tax, total, items } = cartTotals();

      const itemCount = items.reduce((s,i) => s + i.qty, 0);
      if (cartCountEl) cartCountEl.textContent = itemCount;
      if (cartTotalEl) cartTotalEl.textContent = money(total);

      if (cartListEl) {
        cartListEl.innerHTML = "";
        items.forEach(({ product, qty }) => {
          const li = document.createElement("li");
          li.className = "cart-item";

          const name = document.createElement("div");
          name.className = "cart-item-name";
          name.textContent = `${product.title || product.sku}`;

          const controls = document.createElement("div");
          controls.className = "cart-item-controls";

          const minus = document.createElement("button");
          minus.type = "button";
          minus.textContent = "−";
          minus.addEventListener("click", () => changeQty(product.sku, -1));

          const qtySpan = document.createElement("span");
          qtySpan.textContent = qty;

          const plus = document.createElement("button");
          plus.type = "button";
          plus.textContent = "+";
          plus.addEventListener("click", () => changeQty(product.sku, 1));

          controls.append(minus, qtySpan, plus);

          const lineTotal = document.createElement("div");
          lineTotal.className = "cart-item-total";
          lineTotal.textContent = money((product.price || 0) * qty);

          li.append(name, controls, lineTotal);
          cartListEl.appendChild(li);
        });
      }

      if (cartSubEl)   cartSubEl.textContent   = money(sub);
      if (cartTaxEl)   cartTaxEl.textContent   = money(tax);
      if (cartGrandEl) cartGrandEl.textContent = money(total);
    }

    if (cartToggle && cartPanel) {
  cartToggle.addEventListener("click", () => {
    cartPanel.classList.toggle("open");

    // When opening, scroll the inside to the very top
    if (cartPanel.classList.contains("open")) {
      const inner = cartPanel.querySelector(".cart-panel-inner");
      if (inner) inner.scrollTop = 0;
    }
  });
}

    // Close cart when user clicks the "Shop" button in the header
document.querySelectorAll('a[href="#shop"]').forEach(link => {
  link.addEventListener('click', () => {
    if (cartPanel) {
      cartPanel.classList.remove("open");
    }
  });
});
    
    // =========================
    //  STRIPE CHECKOUT
    // =========================
    async function checkoutWithStripe() {
      const { total, items } = cartTotals();
      if (!items.length) {
        alert("Your cart is empty.");
        return;
      }

      if (total < 0.5) {
        alert("Order total must be at least $0.50 to pay by card.");
        return;
      }

      const UNIT = 0.10;
      const quantity = Math.round(total / UNIT);

      const description = items
        .map(i => `${i.qty}x ${i.product.sku || i.product.title}`)
        .join(", ")
        .slice(0, 500);

      try {
        const { error } = await stripe.redirectToCheckout({
          lineItems: [{ price: STRIPE_PRICE_ID, quantity }],
          mode: "payment",
          successUrl: window.location.origin + window.location.pathname + "?checkout=success",
          cancelUrl:  window.location.origin + window.location.pathname + "?checkout=cancel",
          clientReferenceId: description
        });

        if (error) {
          console.error(error);
          alert(error.message || "There was a problem starting checkout.");
        }
      } catch (err) {
        console.error(err);
        alert("Something went wrong starting Stripe Checkout.");
      }
    }

    if (checkoutBtn) {
      checkoutBtn.addEventListener("click", checkoutWithStripe);
    }

    // =========================
    //  CHECKOUT STATUS BANNER
    // =========================
    function handleCheckoutStatus() {
      if (!checkoutMsgBar) return;
      const params = new URLSearchParams(window.location.search);
      const status = params.get("checkout");
      if (!status) return;

      if (status === "success") {
        checkoutMsgBar.textContent = "Thank you! Your payment was received. We’ll message you with pickup details.";
        checkoutMsgBar.classList.add("ok");
      } else if (status === "cancel") {
        checkoutMsgBar.textContent = "Checkout was canceled – your cart is still here if you want to try again.";
        checkoutMsgBar.classList.add("warn");
      } else {
        return;
      }
      checkoutMsgBar.classList.remove("hidden");
    }

    // =========================
    //  IMAGE MODAL LOGIC
    // =========================
    function showModalImage(index) {
      if (!modalImages.length || !imageModalMain) return;

      if (index < 0) index = modalImages.length - 1;
      if (index >= modalImages.length) index = 0;
      modalIndex = index;

      const src = modalImages[index];

      // trigger fade
      imageModalMain.classList.remove("fade-in");
      void imageModalMain.offsetWidth;
      imageModalMain.src = src;
      imageModalMain.classList.add("fade-in");

      if (imageModalCount) {
        imageModalCount.textContent = (index + 1) + " / " + modalImages.length;
      }
      if (imageModalCaption) {
        imageModalCaption.textContent = modalProduct?.title || "";
      }

      if (imageModalThumbs) {
        [...imageModalThumbs.querySelectorAll("img")].forEach((img, i) => {
          img.classList.toggle("active-thumb", i === index);
        });
      }
    }

    function openImageModal(product, startIndex = 0) {
      modalProduct = product;
      modalImages  = getAllImages(product);
      modalIndex   = startIndex || 0;

      if (!imageModal) return;

      if (imageModalThumbs) {
        imageModalThumbs.innerHTML = "";
        modalImages.forEach((src, i) => {
          const t = document.createElement("img");
          t.src = src;
          t.alt = (product.title || "Item") + " " + (i + 1);
          t.addEventListener("click", () => showModalImage(i));
          imageModalThumbs.appendChild(t);
        });
      }

      imageModal.classList.remove("hidden");
      document.body.classList.add("modal-open");
      modalOpen = true;
      showModalImage(modalIndex);
    }

    function closeImageModal() {
      if (!imageModal) return;
      imageModal.classList.add("hidden");
      document.body.classList.remove("modal-open");
      modalOpen = false;
      if (imageModalMain) imageModalMain.classList.remove("zoomed");
    }

    // Modal event wiring
    if (imageModalBackdrop) {
      imageModalBackdrop.addEventListener("click", closeImageModal);
    }
    if (imageModalCloseBtn) {
      imageModalCloseBtn.addEventListener("click", closeImageModal);
    }
    if (imageModalArrowLeft) {
      imageModalArrowLeft.addEventListener("click", () => showModalImage(modalIndex - 1));
    }
    if (imageModalArrowRight) {
      imageModalArrowRight.addEventListener("click", () => showModalImage(modalIndex + 1));
    }

    // Tap to zoom
    if (imageModalMain) {
      imageModalMain.addEventListener("click", () => {
        imageModalMain.classList.toggle("zoomed");
      });

      // Swipe left/right on touch
      imageModalMain.addEventListener("touchstart", (e) => {
        if (!e.touches.length) return;
        touchStartX = e.touches[0].clientX;
      });
      imageModalMain.addEventListener("touchend", (e) => {
        if (!e.changedTouches.length) return;
        const dx = e.changedTouches[0].clientX - touchStartX;
        if (Math.abs(dx) > 40) {
          if (dx < 0) showModalImage(modalIndex + 1);
          else        showModalImage(modalIndex - 1);
        }
      });
    }

    // Keyboard navigation
    document.addEventListener("keydown", (e) => {
      if (!modalOpen) return;
      if (e.key === "Escape") {
        closeImageModal();
      } else if (e.key === "ArrowRight") {
        showModalImage(modalIndex + 1);
      } else if (e.key === "ArrowLeft") {
        showModalImage(modalIndex - 1);
      }
    });
// Close cart & jump to products when "Shop" is clicked
const shopLinks = document.querySelectorAll('a[href="#shop"]');
shopLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    if (cartPanel) cartPanel.classList.remove('open');
    const shopSection = document.getElementById('shop');
    if (shopSection) {
      shopSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
});
    
    // =========================
    //  INIT
    // =========================
    loadProducts();
    handleCheckoutStatus();
  </script>
</body>
</html>
