<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlashBidz Store — Local Deals • Mattawan, MI</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <meta name="description" content="FlashBidz — fixed-price local deals with easy pickup in Mattawan, MI." />
</head>
<body>
  <header class="site-header" id="top">
    <a class="brand" href="#top">
      <img src="img/flashbidz_logo.svg" alt="FlashBidz" class="logoimg" />
      <div class="name">
        <h1>FlashBidz Store</h1>
        <p class="tagline">Neighbors Helping Neighbors • Mattawan, MI</p>
      </div>
    </a>
    <nav class="top-cta">
      <a class="btn btn-primary" href="#shop">Shop</a>
      <a class="btn" href="#pickup">Pickup Info</a>
      <a class="btn" href="https://www.facebook.com/flashbidz.mattawan" target="_blank" rel="noopener">Message on Facebook</a>
    </nav>
  </header>

  <!-- Cart bar -->
  <section class="cart-bar" aria-label="Shopping cart">
    <button id="cart-toggle" class="btn cart-btn" type="button">
      Cart (<span id="cart-count">0</span>) • <span id="cart-total">$0.00</span>
    </button>
  </section>

  <!-- Slide-out cart panel -->
  <div id="cart-panel" class="cart-panel hidden" aria-hidden="true">
    <div class="cart-panel-inner">
      <h3>Your Cart</h3>
      <div id="cart-items" class="cart-items"></div>

      <div class="cart-summary">
        <div>Subtotal: <strong id="cart-subtotal">$0.00</strong></div>
        <div>MI Tax (6%): <strong id="cart-tax">$0.00</strong></div>
        <div>Total: <strong id="cart-grand-total">$0.00</strong></div>
      </div>

      <p class="cart-note-label">Payment note we’ll attach (you may see it in Venmo/Cash App):</p>
      <pre id="cart-note" class="cart-note"></pre>

      <div class="actions two co-actions">
        <button id="cart-venmo" class="btn pay venmo" type="button">Pay with Venmo</button>
        <button id="cart-cash" class="btn pay cashapp" type="button">Pay with Cash App</button>
      </div>

      <p class="cart-help">
        After you pay, please send us a quick Facebook message with a screenshot so we can match your payment to your order.
      </p>
    </div>
  </div>

  <section class="hero">
    <h2>Local Deals • Easy Pickup • No Bidding</h2>
    <p>Prices shown are <strong>before tax</strong>. Michigan sales tax is added at checkout.</p>
    <div class="hero-cta">
      <input id="q" class="search" type="search" placeholder="Search items… (e.g., bassinet, tools, Barbie)" aria-label="Search products" />
      <a class="btn btn-primary hero-browse" href="#shop" onclick="document.getElementById('q').focus()">Browse All</a>
    </div>
  </section>

  <main id="shop" class="container">
    <div class="toolbar">
      <div class="toolbar-left">
        <label class="toolbar-label">
          Category:
          <select id="cat" class="select">
            <option value="">All categories</option>
          </select>
        </label>
      </div>
      <div class="toolbar-right">
        <label class="toolbar-label">
          Sort:
          <select id="sort" class="select">
            <option value="new">Newest</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
          </select>
        </label>
        <span id="count" class="count"></span>
      </div>
    </div>

    <div id="product-grid" class="grid" aria-live="polite"></div>
  </main>

  <section id="pickup" class="pickup container">
    <h3>Pickup, Payment & Policies</h3>
    <ul>
      <li><strong>Pickup:</strong> Mattawan, MI (exact address provided after purchase). Please pick up within <strong>7 days</strong>.</li>
      <li><strong>Storage:</strong> After 7 days, <strong>$2 per item per day</strong>. After 14 days, items are <strong>abandoned</strong>.</li>
      <li><strong>Payment:</strong> Pay with <strong>Venmo or Cash App</strong>. MI <strong>6% sales tax</strong> is included in the total.</li>
      <li><strong>Condition:</strong> Items sold <em>AS-IS, WHERE-IS</em>. <strong>All sales final.</strong></li>
      <li><strong>Questions?</strong> Message us on Facebook or email <a href="mailto:support@flashbidz.net">support@flashbidz.net</a>.</li>
    </ul>
  </section>

  <footer class="site-footer">
    <p>© <span id="year"></span> FlashBidz of Mattawan • All sales final • AS-IS, WHERE-IS</p>
  </footer>

  <!-- Product card template -->
  <template id="product-card-tpl">
    <article class="card">
      <div class="img-wrap">
        <img src="" alt="" loading="lazy" />
        <span class="badge"></span>
      </div>
      <div class="card-body">
        <h4 class="title"></h4>
        <p class="desc"></p>

        <div class="meta">
          <span class="price"></span>
          <span class="stock"></span>
        </div>

        <div class="totals">
          <div>Subtotal: <strong class="subtotal"></strong></div>
          <div>MI Sales Tax (<span class="tax-rate"></span>%): <strong class="tax"></strong></div>
          <div>Total: <strong class="total"></strong></div>
        </div>

        <div class="actions">
          <button class="btn btn-primary add-to-cart" type="button">
            Add to Cart
          </button>
        </div>
      </div>
    </article>
  </template>

  <!-- Image gallery modal -->
  <div id="image-modal" class="image-modal hidden">
    <div class="image-modal-backdrop" onclick="closeImageModal()"></div>
    <div class="image-modal-content">
      <button class="image-modal-close" type="button" onclick="closeImageModal()">×</button>
      <img id="image-modal-main" src="" alt="Product image" />
      <div id="image-modal-thumbs" class="image-modal-thumbs"></div>
    </div>
  </div>

   <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    // =========================
    //  SETTINGS
    // =========================
    const STRIPE_PUBLISHABLE_KEY = "pk_live_51Sa4lgCY2ro7M4zrxnzepY4UR27lu8NuSG1Ig2d29Zg2Mb3bHV58nVMPacWHGbhyOV5qBirT8JTneZODr7UvkuDJ00nwHIISsM";
    const STRIPE_PRICE_ID = "price_REPLACE_ME"; // <-- PUT YOUR Price ID HERE
    const MI_TAX_RATE = 0.06; // 6% Michigan sales tax

    // =========================
    //  BASIC HELPERS
    // =========================
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
    let PRODUCTS = [];
    const CART = {}; // { sku: { product, qty } }

    function money(n) {
      return "$" + (Number(n) || 0).toFixed(2);
    }

    function getMainImage(p) {
      if (p.images && p.images.length) return p.images[0];
      if (p.image) return p.image;
      return "img/placeholder.png";
    }

    // =========================
    //  LOAD PRODUCTS + BUILD GRID
    // =========================
    const grid = document.getElementById("product-grid");
    const tpl = document.getElementById("product-card-tpl");
    const qInput = document.getElementById("q");
    const catSelect = document.getElementById("cat");
    const sortSelect = document.getElementById("sort");
    const countEl = document.getElementById("count");

    async function loadProducts() {
      const res = await fetch("products.json?" + Date.now());
      const data = await res.json();
      PRODUCTS = data.products || [];

      // Build category dropdown
      const cats = Array.from(
        new Set(PRODUCTS.flatMap(p => p.categories || []))
      ).sort();
      cats.forEach(c => {
        if (!c) return;
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        catSelect.appendChild(opt);
      });

      renderGrid();
    }

    function renderGrid() {
      const query = (qInput.value || "").toLowerCase().trim();
      const selectedCat = catSelect.value;
      const sort = sortSelect.value;

      let items = PRODUCTS.filter(p => p.active !== false);

      if (selectedCat) {
        items = items.filter(p => (p.categories || []).includes(selectedCat));
      }
      if (query) {
        items = items.filter(p =>
          (p.title + " " + (p.description || "")).toLowerCase().includes(query)
        );
      }

      if (sort === "price-asc") {
        items.sort((a, b) => (a.price || 0) - (b.price || 0));
      } else if (sort === "price-desc") {
        items.sort((a, b) => (b.price || 0) - (a.price || 0));
      } else {
        items.sort(
          (a, b) => new Date(b.added_at || 0) - new Date(a.added_at || 0)
        );
      }

      grid.innerHTML = "";
      items.forEach(p => {
        const node = tpl.content.cloneNode(true);

        const img = node.querySelector("img");
        const titleEl = node.querySelector(".title");
        const descEl = node.querySelector(".desc");
        const priceEl = node.querySelector(".price");
        const stockEl = node.querySelector(".stock");
        const badgeEl = node.querySelector(".badge");
        const subEl = node.querySelector(".subtotal");
        const taxEl = node.querySelector(".tax");
        const totalEl = node.querySelector(".total");
        const taxRateEl = node.querySelector(".tax-rate");

        // Use existing card layout, but we ignore the Venmo/CashApp buttons.
        const btnWrapper = node.querySelector(".actions");
        btnWrapper.innerHTML = "";
        const addBtn = document.createElement("button");
        addBtn.className = "btn btn-primary btn-cart";
        addBtn.type = "button";
        addBtn.textContent = "Add to Cart";
        addBtn.addEventListener("click", () => addToCart(p));
        btnWrapper.appendChild(addBtn);

        img.src = getMainImage(p);
        img.alt = p.title || "Item";

        titleEl.textContent = p.title;
        descEl.textContent = p.description || "";
        priceEl.textContent = p.price ? money(p.price) : "";
        stockEl.textContent = p.stock && p.stock > 0 ? "In Stock" : "Sold Out";

        if (p.badge) badgeEl.textContent = p.badge;
        else badgeEl.remove();

        const subtotal = Number(p.price || 0);
        const tax = +(subtotal * MI_TAX_RATE).toFixed(2);
        const total = +(subtotal + tax).toFixed(2);
        taxRateEl.textContent = (MI_TAX_RATE * 100).toFixed(0);
        subEl.textContent = money(subtotal);
        taxEl.textContent = money(tax);
        totalEl.textContent = money(total);

        grid.appendChild(node);
      });

      countEl.textContent =
        items.length + " item" + (items.length === 1 ? "" : "s");
    }

    qInput.addEventListener("input", renderGrid);
    catSelect.addEventListener("change", renderGrid);
    sortSelect.addEventListener("change", renderGrid);

    // =========================
    //  CART
    // =========================
    const cartCountEl = document.getElementById("cart-count");
    const cartTotalEl = document.getElementById("cart-total");
    const cartListEl = document.getElementById("cart-items");
    const cartPanel = document.getElementById("cart-panel");
    const cartToggle = document.getElementById("cart-toggle");

    function addToCart(product) {
      if (!product.sku) return;
      if (!CART[product.sku]) {
        CART[product.sku] = { product, qty: 0 };
      }
      CART[product.sku].qty += 1;
      updateCartUI();
    }

    function changeQty(sku, delta) {
      const entry = CART[sku];
      if (!entry) return;
      entry.qty += delta;
      if (entry.qty <= 0) delete CART[sku];
      updateCartUI();
    }

    function getCartItems() {
      return Object.values(CART);
    }

    function cartTotals() {
      const items = getCartItems();
      let sub = 0;
      items.forEach(i => {
        sub += (Number(i.product.price) || 0) * i.qty;
      });
      const tax = +(sub * MI_TAX_RATE).toFixed(2);
      const total = +(sub + tax).toFixed(2);
      return { sub, tax, total, items };
    }

    function updateCartUI() {
      const { sub, tax, total, items } = cartTotals();

      // summary bar
      const itemCount = items.reduce((s, i) => s + i.qty, 0);
      cartCountEl.textContent = itemCount;
      cartTotalEl.textContent = money(total);

      // list
      cartListEl.innerHTML = "";
      items.forEach(({ product, qty }) => {
        const li = document.createElement("li");
        li.className = "cart-item";

        const name = document.createElement("div");
        name.className = "cart-item-name";
        name.textContent = `${product.title || product.sku}`;

        const controls = document.createElement("div");
        controls.className = "cart-item-controls";

        const minus = document.createElement("button");
        minus.type = "button";
        minus.textContent = "−";
        minus.addEventListener("click", () => changeQty(product.sku, -1));

        const qtySpan = document.createElement("span");
        qtySpan.textContent = qty;

        const plus = document.createElement("button");
        plus.type = "button";
        plus.textContent = "+";
        plus.addEventListener("click", () => changeQty(product.sku, 1));

        controls.append(minus, qtySpan, plus);

        const lineTotal = document.createElement("div");
        lineTotal.className = "cart-item-total";
        lineTotal.textContent = money((product.price || 0) * qty);

        li.append(name, controls, lineTotal);
        cartListEl.appendChild(li);
      });

      // totals in panel
      document.getElementById("cart-subtotal").textContent = money(sub);
      document.getElementById("cart-tax").textContent = money(tax);
      document.getElementById("cart-grandtotal").textContent = money(total);
    }

    // open/close cart
    cartToggle.addEventListener("click", () => {
      cartPanel.classList.toggle("open");
    });

    // =========================
    //  STRIPE CHECKOUT
    // =========================
    async function checkoutWithStripe() {
      const { total, items } = cartTotals();
      if (!items.length) {
        alert("Your cart is empty.");
        return;
      }

      // Stripe minimum charge is about $0.50
      if (total < 0.5) {
        alert("Order total must be at least $0.50 to pay by card.");
        return;
      }

      // Convert total into quantity of 10¢ units
      const UNIT = 0.10;
      const quantity = Math.round(total / UNIT);

      const description = items
        .map(i => `${i.qty}x ${i.product.sku || i.product.title}`)
        .join(", ")
        .slice(0, 500);

      try {
        const { error } = await stripe.redirectToCheckout({
          lineItems: [{ price: STRIPE_PRICE_ID, quantity }],
          mode: "payment",
          successUrl:
            window.location.origin +
            window.location.pathname +
            "?checkout=success",
          cancelUrl:
            window.location.origin +
            window.location.pathname +
            "?checkout=cancel",
          clientReferenceId: description
        });

        if (error) {
          console.error(error);
          alert(error.message || "There was a problem starting checkout.");
        }
      } catch (err) {
        console.error(err);
        alert("Something went wrong starting Stripe Checkout.");
      }
    }

    document.getElementById("checkout-btn")
      .addEventListener("click", checkoutWithStripe);

    // =========================
    //  SHOW SUCCESS / CANCEL MESSAGE
    // =========================
    function handleCheckoutStatus() {
      const params = new URLSearchParams(window.location.search);
      const status = params.get("checkout");
      const bar = document.getElementById("checkout-message");
      if (!status || !bar) return;

      if (status === "success") {
        bar.textContent = "Thank you! Your payment was received. We’ll message you with pickup details.";
        bar.classList.add("ok");
      } else if (status === "cancel") {
        bar.textContent = "Checkout was canceled – your cart is still here if you want to try again.";
        bar.classList.add("warn");
      } else {
        return;
      }

      bar.classList.remove("hidden");
    }

    // =========================
    //  INIT
    // =========================
    document.getElementById("year").textContent = new Date().getFullYear();

    loadProducts();
    handleCheckoutStatus();
  </script>
</body>
</html>
